<!DOCTYPE html><html lang="fr"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Pointages Intérim – Suite complète</title>
<style>
:root{--bg:#f8fafc;--panel:#fff;--muted:#64748b;--border:#e2e8f0;--text:#0f172a;--accent:#0ea5e9;--danger:#ef4444;--alt:#f0f9ff}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:linear-gradient(#f8fafc,#fff);color:var(--text)}
.container{max-width:1400px;margin:24px auto;padding:0 16px}.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.sp{height:8px}.muted{color:var(--muted)}.right{display:flex;justify-content:flex-end}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}.panel .hd{padding:12px 16px;border-bottom:1px solid var(--border)}.panel .bd{padding:14px 16px}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input[type=text],input[type=date],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;outline:none}textarea{min-height:44px}
button{appearance:none;border:1px solid var(--border);background:#fff;padding:9px 12px;border-radius:10px;font-weight:600;cursor:pointer}button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:12px}.badges{display:flex;flex-wrap:wrap;gap:8px}
.grid{display:grid;gap:12px}.scroll{overflow:auto}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:8px 10px;background:#fff;vertical-align:top}
th:first-child,td:first-child{border-left:1px solid var(--border)}tr:first-child th{border-top:1px solid var(--border)}th{position:sticky;top:0;background:#f8fafc;font-size:13px;text-align:left;z-index:1}
tfoot td{background:#f1f5f9;font-weight:700}.small{font-size:12px;color:var(--muted)}.hidden{display:none}
.nav{position:sticky;top:0;background:#ffffffcc;backdrop-filter:saturate(180%) blur(4px);border-bottom:1px solid var(--border);z-index:10}
.nav .wrap{max-width:1400px;margin:0 auto;padding:8px 12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.nav a{padding:8px 12px;border:1px solid var(--border);border-radius:10px;text-decoration:none;color:inherit}.nav a.active{background:#e0f2fe;border-color:#bae6fd}
.brand{display:flex;align-items:center;gap:10px}.brand img{height:28px;object-fit:contain}
.col-week{background:#eef6ff;font-weight:700;text-align:center}.col-day{font-size:11px;color:#334155}
.alt{background:var(--alt)}
</style></head><body>
<div class="nav"><div class="wrap">
  <div class="brand"><img id="logo-bourdarios" alt="Bourdarios" src="" referrerpolicy="no-referrer"/><strong>Pointages Intérim</strong></div>
  <a href="#chantiers" data-page="chantiers">Chantiers</a>
  <a href="#ouvriers" data-page="ouvriers">Ouvriers</a>
  <a href="#agences" data-page="agences">Agences</a>
  <a href="#pointage" data-page="pointage">Pointage hebdo</a>
  <a href="#planning" data-page="planning" class="active">Planning annuel</a>
  <a href="#diffusion" data-page="diffusion">Diffusion</a>
</div></div>

<div class="container">

<!-- Chantiers -->
<section id="page-chantiers" class="hidden">
  <div class="panel"><div class="hd"><strong>Chantiers</strong></div>
    <div class="bd">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div><label>Nom du chantier</label><input type="text" id="ch-nom" placeholder="Ex : M96 W01S"></div>
        <div><label>Code DA</label><input type="text" id="ch-code" placeholder="Code DA"></div>
        <div><label>Nom DA</label><input type="text" id="ch-nomda" placeholder="Nom DA"></div>
        <div><label>Encadrant</label><input type="text" id="ch-enc" placeholder="Encadrant"></div>
        <div style="grid-column:1/-1"><label>Adresse</label><input type="text" id="ch-addr" placeholder="Adresse complète"></div>
        <div style="align-self:end"><button id="btn-add-chantier" class="primary">Ajouter le chantier</button></div>
      </div>
      <div class="sp"></div>
      <div class="scroll"><table id="tbl-chantiers"></table></div>
    </div>
  </div>
</section>

<!-- Ouvriers -->
<section id="page-ouvriers" class="hidden">
  <div class="panel"><div class="hd"><strong>Ouvriers</strong></div>
    <div class="bd">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(190px,1fr))">
        <div><label>Prénom</label><input type="text" id="ov-prenom"></div>
        <div><label>Nom</label><input type="text" id="ov-nom"></div>
        <div><label>Agence</label><select id="ov-agence"></select></div>
        <div><label>Métier</label>
          <select id="ov-metier">
            <option></option><option>Polyvalent</option><option>Plaquiste</option><option>Plombier</option>
            <option>Électricien</option><option>Carreleur</option><option>Peintre</option><option>Jointeur</option>
            <option>Maçon</option><option>Menuisier</option><option>Manœuvre</option>
          </select>
        </div>
        <div><label>Qualification</label>
          <select id="ov-qual"><option></option><option>N1P1</option><option>N2P1</option><option>N2P2</option><option>N3P1</option><option>N3P2</option><option>N4P1</option></select>
        </div>
        <div style="align-self:end"><button id="btn-add-ouvrier" class="primary">Ajouter l'ouvrier</button></div>
      </div>
      <div class="sp"></div>
      <div class="scroll"><table id="tbl-ouvriers"></table></div>
    </div>
  </div>
</section>

<!-- Agences -->
<section id="page-agences" class="hidden">
  <div class="panel"><div class="hd"><strong>Agences</strong></div>
    <div class="bd">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div><label>Agence</label><input type="text" id="ag-nom" placeholder="YES / SAMSIC / …"></div>
        <div><label>Contact e-mail</label><input type="text" id="ag-mail" placeholder="contact@agence.fr"></div>
        <div style="align-self:end"><button id="btn-add-agence" class="primary">Ajouter l'agence</button></div>
      </div>
      <div class="sp"></div>
      <div class="scroll"><table id="tbl-agences"></table></div>
    </div>
  </div>
</section>

<!-- Pointage hebdo -->
<section id="page-pointage" class="hidden">
  <div class="row" style="justify-content:space-between;align-items:flex-end">
    <div><h1 style="margin:0 0 4px;font-size:28px">Pointage hebdo</h1><div class="small" id="subtitle"></div></div>
    <div class="row">
      <label class="badge"><input type="checkbox" id="chk-weekend"> Inclure week-end</label>
      <label class="badge"><input type="checkbox" id="chk-lock"> Verrouiller</label>
    </div>
  </div>
  <div class="panel" style="margin-top:16px">
    <div class="hd"><strong>Paramètres & filtres</strong></div>
    <div class="bd grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))">
      <div><label>Semaine à pointer</label><div class="row"><input type="date" id="inp-week-pointer"><button id="btn-week-today">Aujourd'hui</button></div></div>
      <div><label>Recherche</label><input type="text" id="inp-search" placeholder="Nom, agence, chantier…"></div>
    </div>
    <div class="bd row"><div><div class="small">Filtre Agence</div><div id="badges-agencies" class="badges"></div></div><div><div class="small">Filtre Chantier</div><div id="badges-chantiers" class="badges"></div></div></div>
  </div>
  <div class="panel" style="margin-top:16px">
    <div class="hd"><strong>Saisie hebdomadaire</strong><div class="small">Lignes = ouvriers. « Heures classiques » : 7,5 lun-jeu, 7 ven, 0 we (modifiable).</div></div>
    <div class="bd scroll"><table id="tbl-rows"></table></div>
  </div>
</section>

<!-- Planning annuel (page par défaut) -->
<section id="page-planning">
  <div class="panel"><div class="hd"><strong>Planning annuel</strong></div>
    <div class="bd">
      <div class="row"><div><label>Année</label><input type="text" id="pl-year" style="width:120px"></div><div style="align-self:end"><button id="btn-pl-generate" class="primary">Générer</button></div></div>
      <div class="sp"></div><div class="scroll"><table id="tbl-planning"></table></div>
      <div class="small">2 lignes / ouvrier : <em>Heures</em> (« 00,00 Heures ») puis <em>Chantier</em>. Entêtes « Semaine XX ».</div>
    </div>
  </div>
</section>

<!-- Diffusion -->
<section id="page-diffusion" class="hidden">
  <div class="panel"><div class="hd"><strong>Diffusion aux agences</strong></div>
    <div class="bd">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))">
        <div><label>Semaine à diffuser</label><input type="date" id="df-week"></div>
        <div><label>Agences</label><div id="df-agencies" class="badges"></div></div>
      </div>
      <div class="sp"></div><div class="right"><button id="btn-df-generate" class="primary">Générer les tableaux</button></div>
      <div class="sp"></div>
      <div id="df-results"></div>
      <div class="sp"></div>
      <div id="df-mails" class="small"></div>
    </div>
  </div>
</section>
</div>

<script>
(()=>{"use strict";
/* ------- Logos ------- */
const LOGO_BOURDARIOS_URL=""; if(LOGO_BOURDARIOS_URL){const img=document.getElementById("logo-bourdarios");if(img)img.src=LOGO_BOURDARIOS_URL}

/* ------- Constantes & utils ------- */
const LS_ROWS="ptg_rows_v6",LS_META="ptg_meta_v6",LS_ENTS="ptg_entities_v6",MAX_DAILY=10,$=s=>document.querySelector(s);
const WEEKDAY_FR=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];const DAY_KEYS=["mon","tue","wed","thu","fri","sat","sun"];const KEY_FROM_IDX=["sun","mon","tue","wed","thu","fri","sat"];
const fmt=d=>new Date(d).toLocaleDateString("fr-FR"),isoWeekStart=d=>{let x=new Date(d),g=(x.getDay()+6)%7;x.setDate(x.getDate()-g);x.setHours(0,0,0,0);return x};
const addDays=(d,n)=>{let x=new Date(d);x.setDate(x.getDate()+n);return x},toDateInput=d=>{let x=new Date(d.getTime()-d.getTimezoneOffset()*6e4);return x.toISOString().slice(0,10)},uid=()=>Math.random().toString(36).slice(2,9);
const hourOptions=Array.from({length:21},(_,i)=>(i*.5).toFixed(1).replace(/\.0$/,""));

/* Formatages nom/prénom/chantier */
const trimLower=s=>(s||"").trim().toLowerCase();
const toTitleCaseHyphen=name=>(name||"").split("-").map(p=>p?p[0].toUpperCase()+p.slice(1).toLowerCase():"").join("-");
const toUpper=s=>(s||"").toUpperCase();
const chantierNameUpper=s=>toUpper((s||"").trim());

/* ------- État ------- */
let weekStart=isoWeekStart(new Date),search="",agencyFilter=[],chantierFilter=[],lock=false,includeWeekend=false;
let data={agencies:[],chantiers:[],ouvriers:[],rows:[]}; // rows: {id,week,workerId,days:{mon:{h,chantier},...}}

/* ------- Persistance ------- */
function save(){localStorage.setItem(LS_ENTS,JSON.stringify({agencies:data.agencies,chantiers:data.chantiers,ouvriers:data.ouvriers}));localStorage.setItem(LS_ROWS,JSON.stringify(data.rows));localStorage.setItem(LS_META,JSON.stringify({weekStart,lock,includeWeekend}))}
function load(){try{let e=JSON.parse(localStorage.getItem(LS_ENTS)||"null");if(e){data.agencies=e.agencies||[];data.chantiers=e.chantiers||[];data.ouvriers=e.ouvriers||[]}}catch{}
try{let r=JSON.parse(localStorage.getItem(LS_ROWS)||"null");if(Array.isArray(r))data.rows=r}catch{}
try{let m=JSON.parse(localStorage.getItem(LS_META)||"null");if(m){if(m.weekStart)weekStart=new Date(m.weekStart);lock=!!m.lock;includeWeekend=!!m.includeWeekend}}catch{}}
load();

/* ------- Defaults (si vide) ------- */
if(!data.agencies.length)data.agencies=[{name:"SAMSIC",email:""},{name:"BPS",email:""},{name:"SOVITRAT",email:""},{name:"YES",email:""}];
if(!data.chantiers.length)data.chantiers=[
  {id:uid(),name:"M96 W18S",code:"1224",nomda:"Airbus sanitaires 2025",enc:"Christophe",addr:"10 avenue Yves Brunaud"},
  {id:uid(),name:"M01 N00S",code:"1224",nomda:"Airbus sanitaires 2025",enc:"Alexis",addr:"10 avenue Yves Brunaud"}
];
if(!data.ouvriers.length)data.ouvriers=[
  {id:uid(),first:"Baudouin",last:"RIBERON",agency:"SAMSIC",metier:"Plaquiste",qual:"N3P1"},
  {id:uid(),first:"Laurent",last:"JOLY",agency:"BPS",metier:"Plombier",qual:"N3P2"},
  {id:uid(),first:"Jean-Marc",last:"GOUZY",agency:"SAMSIC",metier:"Polyvalent",qual:"N4P1"}
];

/* ------- Clés & calculs ------- */
function toWeekKey(d){const s=isoWeekStart(d);let t=new Date(Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())),dn=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-dn);const yStart=new Date(Date.UTC(t.getUTCFullYear(),0,1));const w=Math.ceil((((t-yStart)/864e5)+1)/7);return `${t.getUTCFullYear()}-W${String(w).padStart(2,"0")}`}
function weekNoFromDate(d){return toWeekKey(d).split("-W")[1]}

/* ------- Routing ------- */
function showPage(n){["chantiers","ouvriers","agences","pointage","planning","diffusion"].forEach(p=>{const el=$("#page-"+p);if(!el)return;el.classList.toggle("hidden",p!==n)});document.querySelectorAll(".nav a").forEach(a=>a.classList.toggle("active",a.dataset.page===n));
if(n==="chantiers")renderChantiers();if(n==="ouvriers")renderOuvriers();if(n==="agences")renderAgences();if(n==="pointage")renderPointage();if(n==="planning")renderPlanning();if(n==="diffusion")renderDiffusionBadges()}
document.querySelectorAll(".nav a").forEach(a=>a.addEventListener("click",e=>{e.preventDefault();showPage(a.dataset.page)}));

/* ------- Helpers UI ------- */
function setSubtitle(){$("#subtitle").textContent=`Semaine du ${fmt(isoWeekStart(weekStart))}`}
function fillWeekInputs(){const a=$("#inp-week-pointer");if(a)a.value=toDateInput(weekStart);const b=$("#df-week");if(b)b.value=toDateInput(weekStart)}
function hoursSelect(v){const s=document.createElement("select");s.innerHTML=hourOptions.map(x=>`<option value="${x}" ${String(v)===String(x)?"selected":""}>${x}</option>`).join("");return s}
function chantierSelect(val){const s=document.createElement("select");s.innerHTML='<option value=""></option>'+data.chantiers.map(c=>`<option ${val===c.name?"selected":""}>${c.name}</option>`).join("");return s}

/* ===================== AGENCES ===================== */
function renderAgences(){const tbl=$("#tbl-agences");tbl.innerHTML="";const th=document.createElement("thead"),trh=document.createElement("tr");["Agence","E-mail"," "].forEach(h=>{const th1=document.createElement("th");th1.textContent=h;trh.appendChild(th1)});th.appendChild(trh);tbl.appendChild(th);
const tb=document.createElement("tbody");data.agencies.forEach(a=>{const tr=document.createElement("tr");let td=document.createElement("td");const inpn=document.createElement("input");inpn.value=a.name;inpn.oninput=()=>{a.name=inpn.value;save()};td.appendChild(inpn);tr.appendChild(td);
td=document.createElement("td");const inpe=document.createElement("input");inpe.value=a.email||"";inpe.oninput=()=>{a.email=inpe.value;save()};td.appendChild(inpe);tr.appendChild(td);
td=document.createElement("td");const del=document.createElement("button");del.textContent="×";del.onclick=()=>{if(confirm("Supprimer ?")){data.agencies=data.agencies.filter(x=>x!==a);save();renderAgences()}};td.appendChild(del);tr.appendChild(td);tb.appendChild(tr)});tbl.appendChild(tb)}
$("#btn-add-agence")?.addEventListener("click",()=>{const n=$("#ag-nom").value.trim(),m=$("#ag-mail").value.trim();const dup=data.agencies.some(a=>trimLower(a.name)===trimLower(n)&&trimLower(a.email||"")===trimLower(m||""));if(dup){alert("Cette agence existe déjà.");return}if(n){data.agencies.unshift({name:n,email:m});save();renderAgences()}})

/* ===================== CHANTIERS ===================== */
function renderChantiers(){const tbl=$("#tbl-chantiers");tbl.innerHTML="";const th=document.createElement("thead"),trh=document.createElement("tr");["Nom chantier","Code DA","Nom DA","Encadrant","Adresse"," "].forEach(h=>{const th1=document.createElement("th");th1.textContent=h;trh.appendChild(th1)});th.appendChild(trh);tbl.appendChild(th);
const tb=document.createElement("tbody");data.chantiers.forEach(c=>{const tr=document.createElement("tr");
let td=document.createElement("td");const in1=document.createElement("input");in1.value=c.name||"";in1.oninput=()=>{c.name=in1.value.toUpperCase();save()};td.appendChild(in1);tr.appendChild(td);
td=document.createElement("td");const in2=document.createElement("input");in2.value=c.code||"";in2.oninput=()=>{c.code=in2.value;save()};td.appendChild(in2);tr.appendChild(td);
td=document.createElement("td");const in3=document.createElement("input");in3.value=c.nomda||"";in3.oninput=()=>{c.nomda=in3.value;save()};td.appendChild(in3);tr.appendChild(td);
td=document.createElement("td");const in4=document.createElement("input");in4.value=c.enc||"";in4.oninput=()=>{c.enc=in4.value;save()};td.appendChild(in4);tr.appendChild(td);
td=document.createElement("td");const in5=document.createElement("input");in5.value=c.addr||"";in5.oninput=()=>{c.addr=in5.value;save()};td.appendChild(in5);tr.appendChild(td);
td=document.createElement("td");const del=document.createElement("button");del.textContent="×";del.onclick=()=>{if(confirm("Supprimer ?")){data.chantiers=data.chantiers.filter(x=>x!==c);save();renderChantiers()}};td.appendChild(del);tr.appendChild(td);
tb.appendChild(tr)});tbl.appendChild(tb)}
$("#btn-add-chantier")?.addEventListener("click",()=>{const nom=chantierNameUpper($("#ch-nom").value),code=$("#ch-code").value.trim(),nomda=$("#ch-nomda").value.trim(),enc=$("#ch-enc").value.trim(),addr=$("#ch-addr").value.trim();
const dup=data.chantiers.some(c=>chantierNameUpper(c.name)===nom&&trimLower(c.code)===trimLower(code)&&trimLower(c.nomda)===trimLower(nomda)&&trimLower(c.enc)===trimLower(enc)&&trimLower(c.addr)===trimLower(addr));
if(dup){alert("Ce chantier existe déjà.");return}
if(nom){data.chantiers.unshift({id:uid(),name:nom,code,nomda,enc,addr});save();renderChantiers()}})

/* ===================== OUVRIERS ===================== */
function renderOuvriers(){const sel=$("#ov-agence");sel.innerHTML='<option value=""></option>'+data.agencies.map(a=>`<option>${a.name}</option>`).join("");
const tbl=$("#tbl-ouvriers");tbl.innerHTML="";const thead=document.createElement("thead"),trh=document.createElement("tr");["Prénom","Nom","Agence","Métier","Qualification"," "].forEach(h=>{const th=document.createElement("th");th.textContent=h;trh.appendChild(th)});thead.appendChild(trh);tbl.appendChild(thead);
const tb=document.createElement("tbody");
data.ouvriers.forEach(o=>{const tr=document.createElement("tr");
let td=document.createElement("td");const inpf=document.createElement("input");inpf.value=o.first||"";inpf.oninput=()=>{o.first=inpf.value;save()};inpf.onblur=()=>{inpf.value=toTitleCaseHyphen(inpf.value)};td.appendChild(inpf);tr.appendChild(td);
td=document.createElement("td");const inpl=document.createElement("input");inpl.value=o.last||"";inpl.oninput=()=>{o.last=inpl.value;save()};inpl.onblur=()=>{inpl.value=toUpper(inpl.value)};td.appendChild(inpl);tr.appendChild(td);
td=document.createElement("td");const s=document.createElement("select");s.innerHTML='<option value=""></option>'+data.agencies.map(a=>`<option ${o.agency===a.name?"selected":""}>${a.name}</option>`).join("");s.onchange=()=>{o.agency=s.value;save()};td.appendChild(s);tr.appendChild(td);
td=document.createElement("td");const met=document.createElement("select");met.innerHTML='<option></option><option>Polyvalent</option><option>Plaquiste</option><option>Plombier</option><option>Électricien</option><option>Carreleur</option><option>Peintre</option><option>Jointeur</option><option>Maçon</option><option>Menuisier</option><option>Manœuvre</option>';met.value=o.metier||"";met.onchange=()=>{o.metier=met.value;save()};td.appendChild(met);tr.appendChild(td);
td=document.createElement("td");const q=document.createElement("select");q.innerHTML='<option></option><option>N1P1</option><option>N2P1</option><option>N2P2</option><option>N3P1</option><option>N3P2</option><option>N4P1</option>';q.value=o.qual||"";q.onchange=()=>{o.qual=q.value;save()};td.appendChild(q);tr.appendChild(td);
td=document.createElement("td");const del=document.createElement("button");del.textContent="×";del.onclick=()=>{if(confirm("Supprimer ?")){data.ouvriers=data.ouvriers.filter(x=>x.id!==o.id);data.rows=data.rows.filter(r=>r.workerId!==o.id);save();renderOuvriers()}};td.appendChild(del);tr.appendChild(td);
tb.appendChild(tr)});tbl.appendChild(tb)}
$("#btn-add-ouvrier")?.addEventListener("click",()=>{const f=toTitleCaseHyphen($("#ov-prenom").value.trim()),l=toUpper($("#ov-nom").value.trim()),ag=$("#ov-agence").value,met=$("#ov-metier").value,qual=$("#ov-qual").value;
const dup=data.ouvriers.some(o=>trimLower(o.first)===trimLower(f)&&trimLower(o.last)===trimLower(l)&&trimLower(o.agency)===trimLower(ag)&&trimLower(o.metier)===trimLower(met)&&trimLower(o.qual)===trimLower(qual));
if(dup){alert("Cet ouvrier existe déjà.");return}
if(f||l){data.ouvriers.unshift({id:uid(),first:f,last:l,agency:ag||"",metier:met||"",qual:qual||""});save();renderOuvriers()}})

/* ===================== POINTAGE HEBDO ===================== */
function rowsForWeek(ws){const k=toWeekKey(ws);return data.rows.filter(r=>r.week===k)}
function ensureWeekRows(ws){const wk=toWeekKey(ws);const have=new Set(rowsForWeek(ws).map(r=>r.workerId));data.ouvriers.forEach(o=>{if(!have.has(o.id)){data.rows.push({id:uid(),week:wk,workerId:o.id,days:{mon:{h:0,chantier:""},tue:{h:0,chantier:""},wed:{h:0,chantier:""},thu:{h:0,chantier:""},fri:{h:0,chantier:""},sat:{h:0,chantier:""},sun:{h:0,chantier:""}}})}});save()}
function workerById(id){return data.ouvriers.find(o=>o.id===id)||{first:"",last:"",agency:"",metier:"",qual:""}}
function filtered(list){return list.filter(r=>{const w=workerById(r.workerId),okA=agencyFilter.length?agencyFilter.includes(w.agency):true,chs=Object.values(r.days||{}).map(d=>d.chantier).filter(Boolean),okC=chantierFilter.length?chs.some(c=>chantierFilter.includes(c)):true,okS=!search||(`${w.first} ${w.last} ${w.agency} ${w.metier} ${w.qual} ${chs.join(" ")}`.toLowerCase().includes(search.toLowerCase()));return okA&&okC&&okS})}
function totalsPerDay(list,showDays){const mapDays={Lun:"mon",Mar:"tue",Mer:"wed",Jeu:"thu",Ven:"fri",Sam:"sat",Dim:"sun"};const t={mon:0,tue:0,wed:0,thu:0,fri:0,sat:0,sun:0};filtered(list).forEach(r=>{showDays.forEach(lbl=>{const k=mapDays[lbl];const v=r.days?.[k]?.h;if(typeof v==="number")t[k]+=v})});return t}
function renderBadges(){const bag=$("#badges-agencies");if(!bag)return;bag.innerHTML="";const allA=Array.from(new Set(data.agencies.map(a=>a.name).concat(data.ouvriers.map(o=>o.agency).filter(Boolean)))).sort();
allA.forEach(a=>{const b=document.createElement("button");b.className="badge";b.textContent=a;if(agencyFilter.includes(a))b.style.background="#e0f2fe";b.onclick=()=>{agencyFilter=agencyFilter.includes(a)?agencyFilter.filter(x=>x!==a):[...agencyFilter,a];renderPointage()};bag.appendChild(b)});
const rz=document.createElement("button");rz.className="badge";rz.textContent="Réinitialiser";rz.onclick=()=>{agencyFilter=[];renderPointage()};bag.appendChild(rz);
const bch=$("#badges-chantiers");bch.innerHTML="";const allC=Array.from(new Set(data.chantiers.map(c=>c.name).concat(data.rows.flatMap(r=>Object.values(r.days||{}).map(d=>d.chantier||""))))).filter(Boolean).sort();
allC.forEach(c=>{const b=document.createElement("button");b.className="badge";b.textContent=c;if(chantierFilter.includes(c))b.style.background="#e0f2fe";b.onclick=()=>{chantierFilter=chantierFilter.includes(c)?chantierFilter.filter(x=>x!==c):[...chantierFilter,c];renderPointage()};bch.appendChild(b)});
const rz2=document.createElement("button");rz2.className="badge";rz2.textContent="Réinitialiser";rz2.onclick=()=>{chantierFilter=[];renderPointage()};bch.appendChild(rz2)}
function setSubtitle(){$("#subtitle").textContent=`Semaine du ${fmt(isoWeekStart(weekStart))}`}
function applyClassicHours(r){r.days.mon.h=7.5;r.days.tue.h=7.5;r.days.wed.h=7.5;r.days.thu.h=7.5;r.days.fri.h=7;r.days.sat.h=0;r.days.sun.h=0}
function renderPointage(){ensureWeekRows(weekStart);setSubtitle();fillWeekInputs();renderBadges();
const showDays=includeWeekend?["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"]:["Lun","Mar","Mer","Jeu","Ven"];
const showKeys=showDays.map((lbl,i)=>DAY_KEYS[i]); // align Lun..Ven
const tbl=$("#tbl-rows");tbl.innerHTML="";const thead=document.createElement("thead"),trh=document.createElement("tr");
["Agence","Prénom","Nom","Métier","Qualification"].concat(showDays).concat(["Total","Heures classiques"]).forEach((h,i)=>{const th=document.createElement("th"); if(showDays.includes(h)){const idx=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"].indexOf(h);const d=addDays(isoWeekStart(weekStart),idx);th.innerHTML=`<div>${h}</div><div class='small'>${("0"+d.getDate()).slice(-2)}/${("0"+(d.getMonth()+1)).slice(-2)}</div>`} else th.textContent=h; trh.appendChild(th)});thead.appendChild(trh);tbl.appendChild(thead);
const list=filtered(rowsForWeek(weekStart));const tbody=document.createElement("tbody");
list.forEach(r=>{const w=workerById(r.workerId);const tr=document.createElement("tr");
let td=document.createElement("td");td.textContent=w.agency||"";tr.appendChild(td);
td=document.createElement("td");td.textContent=toTitleCaseHyphen(w.first)||"";tr.appendChild(td);
td=document.createElement("td");td.textContent=toUpper(w.last)||"";tr.appendChild(td);
td=document.createElement("td");td.textContent=w.metier||"";tr.appendChild(td);
td=document.createElement("td");td.textContent=w.qual||"";tr.appendChild(td);
showKeys.forEach((k)=>{const cell=document.createElement("td"),wrap=document.createElement("div");
const selH=hoursSelect(r.days?.[k]?.h===""?"":(typeof r.days?.[k]?.h==="number"?r.days[k].h:""));selH.disabled=lock;selH.onchange=()=>{r.days=r.days||{};r.days[k]=r.days[k]||{h:"",chantier:""};r.days[k].h=Number(selH.value);save();renderPointage()};
const selC=chantierSelect(r.days?.[k]?.chantier||"");selC.disabled=lock;selC.onchange=()=>{r.days=r.days||{};r.days[k]=r.days[k]||{h:"",chantier:""};r.days[k].chantier=selC.value;save()};
wrap.appendChild(selH);const s=document.createElement("div");s.className="sp";wrap.appendChild(s);wrap.appendChild(selC);cell.appendChild(wrap);tr.appendChild(cell)});
td=document.createElement("td");td.style.textAlign="right";td.style.fontWeight="700";td.textContent=String(showKeys.reduce((a,k)=>a+(r.days?.[k]?.h||0),0));tr.appendChild(td);
td=document.createElement("td");const b=document.createElement("button");b.textContent="Heures classiques";b.onclick=()=>{applyClassicHours(r);save();renderPointage()};td.appendChild(b);tr.appendChild(td);
tbody.appendChild(tr)});tbl.appendChild(tbody);
const tfoot=document.createElement("tfoot"),trf=document.createElement("tr"),tdb=document.createElement("td");tdb.colSpan=5;trf.appendChild(tdb);
const tday=totalsPerDay(rowsForWeek(weekStart),showDays);showKeys.forEach((k)=>{const td=document.createElement("td");td.style.textAlign="center";td.style.fontWeight="700";td.textContent=String(tday[k]);trf.appendChild(td)});
const tdt=document.createElement("td");tdt.style.fontWeight="800";tdt.style.textAlign="right";tdt.textContent=String(showKeys.reduce((a,k)=>a+(tday[k]||0),0));trf.appendChild(tdt);
const tdf=document.createElement("td");trf.appendChild(tdf);tfoot.appendChild(trf);tbl.appendChild(tfoot)
}
$("#btn-week-today")?.addEventListener("click",()=>{weekStart=isoWeekStart(new Date);save();renderPointage()});
$("#inp-week-pointer")?.addEventListener("change",e=>{weekStart=isoWeekStart(new Date(e.target.value));save();renderPointage()});
$("#chk-lock")?.addEventListener("change",()=>{lock=$("#chk-lock").checked;save();renderPointage()});
$("#chk-weekend")?.addEventListener("change",e=>{includeWeekend=e.target.checked;save();renderPointage()});
$("#inp-search")?.addEventListener("input",e=>{search=e.target.value;renderPointage()});

/* ===================== PLANNING ANNUEL ===================== */
function renderPlanning(){const tbl=$("#tbl-planning");tbl.innerHTML="";const y=parseInt($("#pl-year").value||String(new Date().getFullYear()),10);if(!y){tbl.innerHTML='<tr><td class="small">Saisir une année valide.</td></tr>';return}
const start=new Date(y,0,1),end=new Date(y,11,31);const days=[];for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1))days.push(new Date(d));
const weeks=[];let curW="";days.forEach(d=>{const wk=toWeekKey(d);if(wk!==curW){weeks.push({key:wk,days:[d]});curW=wk}else weeks[weeks.length-1].days.push(d)});
const thead=document.createElement("thead"),trW=document.createElement("tr"),trD=document.createElement("tr");
const thName=document.createElement("th");thName.rowSpan=2;thName.textContent="Ouvrier";trW.appendChild(thName);
weeks.forEach(w=>{const th=document.createElement("th");th.colSpan=w.days.length;th.className="col-week";th.textContent=`Semaine ${w.key.split("-W")[1]}`;trW.appendChild(th);
w.days.forEach(d=>{const thd=document.createElement("th");thd.className="col-day";thd.textContent=`${d.toLocaleDateString("fr-FR",{weekday:"short"})} ${("0"+d.getDate()).slice(-2)}/${("0"+(d.getMonth()+1)).slice(-2)}`;trD.appendChild(thd)})});
thead.appendChild(trW);thead.appendChild(trD);tbl.appendChild(thead);
const tb=document.createElement("tbody");
data.ouvriers.forEach((o,idx)=>{const trH=document.createElement("tr"),trC=document.createElement("tr");
const tdName=document.createElement("td");tdName.rowSpan=2;tdName.textContent=`${toTitleCaseHyphen(o.first||"")} ${toUpper(o.last||"")}`;trH.appendChild(tdName);
if(idx%2===0){trH.classList.add("alt");trC.classList.add("alt")}
weeks.forEach(w=>{w.days.forEach(d=>{const cell=document.createElement("td");const wk=toWeekKey(d);const rr=data.rows.find(r=>r.week===wk&&r.workerId===o.id);if(rr){const dk=KEY_FROM_IDX[d.getDay()],de=rr.days?.[dk];if(de&&de.h>0){let txt=(de.h||0).toFixed(2).replace(".",",");cell.textContent=`${txt} Heures`}}trH.appendChild(cell)})});
weeks.forEach(w=>{w.days.forEach(d=>{const cell=document.createElement("td");const wk=toWeekKey(d);const rr=data.rows.find(r=>r.week===wk&&r.workerId===o.id);if(rr){const dk=KEY_FROM_IDX[d.getDay()],de=rr.days?.[dk];if(de&&de.h>0&&(de.chantier||""))cell.textContent=de.chantier}trC.appendChild(cell)})});
tb.appendChild(trH);tb.appendChild(trC)});
tbl.appendChild(tb)
}
$("#btn-pl-generate")?.addEventListener("click",()=>renderPlanning());

/* ===================== DIFFUSION ===================== */
let dfSelected=new Set();
function renderDiffusionBadges(){const box=$("#df-agencies");box.innerHTML="";data.agencies.forEach(a=>{const b=document.createElement("button");b.className="badge";b.textContent=a.name;if(dfSelected.has(a.name))b.style.background="#e0f2fe";b.onclick=()=>{dfSelected.has(a.name)?dfSelected.delete(a.name):dfSelected.add(a.name);renderDiffusionBadges()};box.appendChild(b)});
const rz=document.createElement("button");rz.className="badge";rz.textContent="Tout";rz.onclick=()=>{if(dfSelected.size===data.agencies.length)dfSelected.clear();else dfSelected=new Set(data.agencies.map(a=>a.name));renderDiffusionBadges()};box.appendChild(rz)}
function makeAgencyTableHTML(ag,wkKey){const days=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];const d0=isoWeekStart(weekStart);
let head=`<thead><tr><th rowspan="2">Ouvrier</th><th class="col-week" colspan="${days.length}">Semaine ${wkKey.split("-W")[1]}</th></tr><tr>`;
days.forEach((lbl,i)=>{const d=new Date(d0);d.setDate(d0.getDate()+i);head+=`<th>${lbl} ${("0"+d.getDate()).slice(-2)}/${("0"+(d.getMonth()+1)).slice(-2)}</th>`});head+=`</tr></thead>`;
const rows=data.rows.filter(r=>r.week===wkKey);
const byAgency=rows.map(r=>({r,w:data.ouvriers.find(o=>o.id===r.workerId)})).filter(x=>x.w&&x.w.agency===ag);
let body="<tbody>";byAgency.forEach(({w,r},idx)=>{const cls=(idx%2===0)?" class='alt'":""; // 2 lignes / ouvrier
body+=`<tr${cls}><td rowspan="2">${toTitleCaseHyphen(w.first)} ${toUpper(w.last)}</td>`;
days.forEach((lbl,i)=>{const k=DAY_KEYS[i];const h=r.days?.[k]?.h||0;body+=`<td>${h>0?String(h.toFixed(2)).replace(".",","):""}</td>`});body+=`</tr>`;
body+=`<tr${cls}>`;days.forEach((lbl,i)=>{const k=DAY_KEYS[i];const h=r.days?.[k]?.h||0;const c=r.days?.[k]?.chantier||"";body+=`<td>${h>0?c:""}</td>`});body+=`</tr>`;
});body+="</tbody>";
return `<table border="1" cellpadding="4" cellspacing="0" style="border-collapse:collapse;width:100%">${head}${body}</table>`;
}
function renderDiffusionTables(){const zone=$("#df-results");const mailZone=$("#df-mails");zone.innerHTML="";mailZone.innerHTML="";
const d=$("#df-week").value;const wk=toWeekKey(new Date(d||weekStart));const weekNo=wk.split("-W")[1];const d0=isoWeekStart(new Date(d||weekStart));
const selectedNames=dfSelected.size?[...dfSelected]:data.agencies.map(a=>a.name);
selectedNames.sort().forEach(ag=>{
  // Build display table (respect weekend option)
  const days=includeWeekend?["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"]:["Lun","Mar","Mer","Jeu","Ven"];
  const tbl=document.createElement("table");tbl.style.width="100%";tbl.style.borderCollapse="collapse";
  const thead=document.createElement("thead");let tr1=document.createElement("tr");let th=document.createElement("th");th.rowSpan=2;th.textContent="Ouvrier";tr1.appendChild(th);
  const thw=document.createElement("th");thw.colSpan=days.length;thw.className="col-week";thw.textContent=`Semaine ${weekNo}`;tr1.appendChild(thw);thead.appendChild(tr1);
  let tr2=document.createElement("tr");days.forEach((lbl,i)=>{const d=new Date(d0);d.setDate(d0.getDate()+i);const thd=document.createElement("th");thd.textContent=`${lbl} ${("0"+d.getDate()).slice(-2)}/${("0"+(d.getMonth()+1)).slice(-2)}`;tr2.appendChild(thd)});thead.appendChild(tr2);tbl.appendChild(thead);
  const tb=document.createElement("tbody");
  const rows=data.rows.filter(r=>r.week===wk).map(r=>({r,w:data.ouvriers.find(o=>o.id===r.workerId)})).filter(x=>x.w&&x.w.agency===ag);
  rows.forEach(({w,r},idx)=>{const trH=document.createElement("tr"),trC=document.createElement("tr");if(idx%2===0){trH.className="alt";trC.className="alt"}
    const tdName=document.createElement("td");tdName.rowSpan=2;tdName.textContent=`${toTitleCaseHyphen(w.first)} ${toUpper(w.last)}`;trH.appendChild(tdName);
    days.forEach((lbl,i)=>{const k=DAY_KEYS[i];const h=r.days?.[k]?.h||0;const td=document.createElement("td");td.textContent=h>0?String(h.toFixed(2)).replace(".",","):"";trH.appendChild(td)});
    days.forEach((lbl,i)=>{const k=DAY_KEYS[i];const h=r.days?.[k]?.h||0;const c=r.days?.[k]?.chantier||"";const td=document.createElement("td");td.textContent=h>0?c:"";trC.appendChild(td)});
    tb.appendChild(trH);tb.appendChild(trC);
  });
  const wrap=document.createElement("div");wrap.className="panel";wrap.style.marginBottom="16px";
  const hd=document.createElement("div");hd.className="hd";hd.innerHTML=`<strong>${ag}</strong> — Semaine ${weekNo}`;wrap.appendChild(hd);
  const bd=document.createElement("div");bd.className="bd";bd.appendChild(tbl);wrap.appendChild(bd);zone.appendChild(wrap);

  // Préparer mail HTML (copie du tableau complet)
  const agencyObj=data.agencies.find(a=>a.name===ag);
  const tableHTML=makeAgencyTableHTML(ag,wk); // avec week-end complet dans mail (clair)
  const subject=encodeURIComponent(`Pointages - ${ag} - Semaine ${weekNo}`);
  const body=encodeURIComponent(tableHTML);
  const href=`mailto:${encodeURIComponent(agencyObj?.email||"")}?subject=${subject}&body=${body}`;
  const link=document.createElement("a");link.className="badge";link.href=href;link.textContent=`📧 Préparer l'e-mail à ${ag}`;mailZone.appendChild(link);
});
if(!selectedNames.length){zone.innerHTML='<div class="small">Aucune agence sélectionnée.</div>'}}
$("#btn-df-generate")?.addEventListener("click",renderDiffusionTables);

/* ===================== Filtres badges ===================== */
function renderBadges(){/* déjà géré dans renderPointage via renderBadges */}

/* ===================== Init (page par défaut = Planning, année courante) ===================== */
function init(){
  // Inputs par défaut
  if($("#pl-year")) $("#pl-year").value=String(new Date().getFullYear());
  fillWeekInputs();
  // Navigation -> planning par défaut
  showPage("planning");
  renderPlanning();
}
init();
})();
</script>
</body></html>