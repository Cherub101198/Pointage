<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tableur — Diffusion</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <style>
    :root{
      --bg:#0f1115; --panel:#171a21; --ink:#e8ebf1; --muted:#9aa4b2;
      --accent:#4da3ff; --ok:#35c759; --warn:#ff9f0a; --err:#ff453a; --line:#262b36;
      --chip:#202532;
      --radius:12px;
      --font: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0d1016,#121723 40%,#0d1016);
      color:var(--ink); font-family:var(--font); -webkit-font-smoothing:antialiased;
    }
    .wrap{max-width:1120px; margin:32px auto; padding:0 20px;}
    .header{
      display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:20px;
    }
    .title{font-size: clamp(20px, 2.6vw, 28px); font-weight:700; letter-spacing:.2px;}
    .badge{
      display:inline-flex; align-items:center; gap:10px; padding:10px 14px; background:var(--chip);
      border:1px solid var(--line); border-radius:999px; font-size:14px; color:var(--muted);
    }
    .dot{width:10px; height:10px; border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.25) inset;}
    .dot.orange{background:var(--warn)}
    .dot.green{background:var(--ok)}
    .panel{
      background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .panel-h{
      display:flex; align-items:center; justify-content:space-between; padding:16px 18px; border-bottom:1px solid var(--line);
    }
    .panel-b{padding:16px 18px;}
    .toolbar{display:flex; flex-wrap:wrap; gap:10px}
    .btn{
      padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#1d2330; color:var(--ink);
      font-size:14px; cursor:pointer; transition:.15s transform ease, .2s background ease; user-select:none;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn.primary{background:linear-gradient(180deg,#2d6bff,#2254d7); border-color:#1e3ea8}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
    .table-wrap{
      width:100%; overflow:auto; border-radius:10px; border:1px solid var(--line);
    }
    table{width:100%; border-collapse:collapse; min-width:720px; background:#0f131c}
    thead th{
      position:sticky; top:0; backdrop-filter: blur(6px);
      background:#0f131cee; color:#c9d1e1; font-weight:600; text-align:left; font-size:13px; letter-spacing:.2px;
      border-bottom:1px solid var(--line); padding:12px 12px;
    }
    tbody td{border-bottom:1px solid var(--line); padding:10px 12px; font-size:14px; color:#e5e9f3}
    tbody tr:hover{background:#121829}
    .pill{
      display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#1a2130; border:1px solid var(--line); color:#cbd5e4;
    }
    .hint{color:var(--muted); font-size:13px; margin-top:10px}
    .field{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    input[type="text"], input[type="email"]{
      background:#0e1422; color:var(--ink); border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:14px;
    }
    .grow{flex:1}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .success{color:var(--ok)}
    .warn{color:var(--warn)}
  </style>
  <!-- EmailJS SDK -->
  <script defer src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ⚠️ REMPLACE PAR TA PUBLIC KEY EMAILJS
      // eslint-disable-next-line no-undef
      emailjs.init({ publicKey: "REMPLACE_AVEC_TA_PUBLIC_KEY" });
    });
  </script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">Diffusion des heures</div>
      <div class="badge" id="saveBadge">
        <span class="dot orange" id="saveDot"></span>
        <span id="saveText">Modifications non enregistrées</span>
      </div>
    </div>

    <div class="panel">
      <div class="panel-h">
        <div class="toolbar">
          <button class="btn" id="btnEnregistrer">Enregistrer</button>
          <button class="btn primary" id="btnEnvoyerMails">Envoyer les emails</button>
          <button class="btn ghost" id="btnApercu">Aperçu email</button>
        </div>
      </div>
      <div class="panel-b">
        <div class="field" style="margin-bottom:12px;">
          <label class="pill">Destinataires (séparés par des virgules)</label>
          <input class="grow" id="destinataires" type="email" placeholder="paul@example.com, jeremy@example.com" />
        </div>
        <div class="field" style="margin-bottom:12px;">
          <label class="pill">Objet</label>
          <input class="grow" id="objet" type="text" value="Synthèse des heures — Semaine en cours" />
        </div>

        <div class="table-wrap" id="tableWrap">
          <table id="tabDiffusion" aria-label="Tableau de diffusion des heures">
            <thead>
              <tr>
                <th>Ouvrier</th>
                <th>Entreprise</th>
                <th>Qualification</th>
                <th class="mono">Heures</th>
                <th>Chantier</th>
                <th>Encadrant</th>
              </tr>
            </thead>
            <tbody id="tbodyDiffusion"></tbody>
          </table>
        </div>

        <p class="hint">
          Les heures sont affichées et envoyées au format <span class="mono">XX,XX&nbsp;Heures</span>.  
          L’envoi des mails est automatique (sans copier-coller) via EmailJS.
        </p>

        <div id="apercuOut" class="hint"></div>
      </div>
    </div>
  </div>

  <script type="module">
    /*********************
     * Données d'exemple *
     *********************/
    const donnees = [
      { nom: "Baudouin RIBERON", entreprise: "SAMSIC", qualification: "Plâquiste N3P1", heures: 35.5, chantier:"M96 W19S", encadrant:"Alexis" },
      { nom: "Laurent JOLY", entreprise: "BPS", qualification: "Plombier N3P2", heures: 28, chantier:"M91 N10S", encadrant:"Jérémy" },
      { nom: "Jean-Marc GOUZY", entreprise: "SAMSIC", qualification: "Polyvalent N4P1", heures: 41.25, chantier:"M65 W01S", encadrant:"Paul" },
    ];

    /***********************
     * Utilitaires format  *
     ***********************/
    function formatHeuresFR(value){
      const num = Number(value ?? 0);
      const fixed = num.toFixed(2);            // "41.25"
      const fr = fixed.replace(".", ",");      // "41,25"
      return `${fr} Heures`;
    }

    function markDirty(){
      const dot = document.getElementById('saveDot');
      const text = document.getElementById('saveText');
      dot.classList.remove('green');
      dot.classList.add('orange');
      text.textContent = "Modifications non enregistrées";
    }
    function markSaved(){
      const dot = document.getElementById('saveDot');
      const text = document.getElementById('saveText');
      dot.classList.remove('orange');
      dot.classList.add('green');
      text.textContent = "Enregistré";
    }

    /************************
     * Rendu du tableau UI  *
     ************************/
    const tbody = document.getElementById('tbodyDiffusion');
    function renderTbody(rows){
      tbody.innerHTML = "";
      rows.forEach((r) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td contenteditable data-k="nom">${r.nom}</td>
          <td contenteditable data-k="entreprise">${r.entreprise}</td>
          <td contenteditable data-k="qualification">${r.qualification}</td>
          <td contenteditable data-k="heures" class="mono" title="Saisir un nombre (ex: 35.5)">${formatHeuresFR(r.heures)}</td>
          <td contenteditable data-k="chantier">${r.chantier}</td>
          <td contenteditable data-k="encadrant">${r.encadrant}</td>
        `;
        tr.querySelectorAll('[contenteditable]').forEach(cell => {
          cell.addEventListener('input', () => {
            markDirty();
            if(cell.dataset.k === 'heures'){
              const txt = cell.textContent.replace(/[^\d.,]/g,"").replace(",",".");
              const num = parseFloat(txt);
              if(!isNaN(num)){
                cell.dataset.raw = String(num);
              }
            }
          });
          cell.addEventListener('blur', () => {
            if(cell.dataset.k === 'heures'){
              const raw = parseFloat((cell.dataset.raw ?? "").toString());
              if(!isNaN(raw)){
                cell.textContent = formatHeuresFR(raw);
              }else{
                const txt = cell.textContent.replace(/[^\d.,]/g,"").replace(",",".");
                const num = parseFloat(txt);
                cell.textContent = formatHeuresFR(isNaN(num)?0:num);
              }
            }
          });
        });
        tbody.appendChild(tr);
      });
    }
    renderTbody(donnees);

    /*********************************
     * Extraction données depuis DOM *
     *********************************/
    function readRows(){
      const out = [];
      tbody.querySelectorAll('tr').forEach(tr=>{
        const grab = k => (tr.querySelector(`[data-k="${k}"]`)?.textContent || "").trim();
        const hCell = tr.querySelector('[data-k="heures"]');
        let heures = 0;
        if(hCell){
          const parsed = hCell.textContent.replace(/[^\d.,]/g,"").replace(",",".");
          const num = parseFloat(parsed);
          heures = isNaN(num) ? 0 : num;
        }
        out.push({
          nom: grab('nom'),
          entreprise: grab('entreprise'),
          qualification: grab('qualification'),
          heures,
          chantier: grab('chantier'),
          encadrant: grab('encadrant'),
        });
      });
      return out;
    }

    /*******************************
     * Enregistrement (mock local) *
     *******************************/
    function enregistrer(){
      const data = readRows();
      localStorage.setItem('diffusion_heures', JSON.stringify(data));
      markSaved();
    }
    document.getElementById('btnEnregistrer').addEventListener('click', enregistrer);

    /****************************************
     * Génération du tableau HTML pour mail *
     ****************************************/
    function buildEmailHtml(rows){
      const styles = `
        table{border-collapse:collapse;width:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
        th,td{border:1px solid #d5d8df;padding:8px 10px;font-size:14px}
        th{background:#f2f4f8;text-align:left}
        .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
      `;
      const head = `
        <tr>
          <th>Ouvrier</th>
          <th>Entreprise</th>
          <th>Qualification</th>
          <th>Heures</th>
          <th>Chantier</th>
          <th>Encadrant</th>
        </tr>
      `;
      const body = rows.map(r=>`
        <tr>
          <td>${escapeHtml(r.nom)}</td>
          <td>${escapeHtml(r.entreprise)}</td>
          <td>${escapeHtml(r.qualification)}</td>
          <td class="mono">${escapeHtml(formatHeuresFR(r.heures))}</td>
          <td>${escapeHtml(r.chantier)}</td>
          <td>${escapeHtml(r.encadrant)}</td>
        </tr>
      `).join("");
      return `
        <div style="font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0b1220">
          <p>Bonjour,</p>
          <p>Veuillez trouver ci-dessous la synthèse des heures :</p>
          <table role="table" aria-label="Synthèse des heures">
            <style>${styles}</style>
            <thead>${head}</thead>
            <tbody>${body}</tbody>
          </table>
          <p style="color:#5f6b7c">— Envoi automatique</p>
        </div>
      `;
    }
    function escapeHtml(s=""){
      return s
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    /***********************
     * Aperçu dans la page *
     ***********************/
    document.getElementById('btnApercu').addEventListener('click', () => {
      const html = buildEmailHtml(readRows());
      const out = document.getElementById('apercuOut');
      out.innerHTML = `<div class="success">Aperçu du contenu HTML qui sera envoyé :</div><div style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#101525">${html}</div>`;
    });

    /*****************
     * Envoi EmailJS *
     *****************
     * Prérequis :
     * 1) Crée un compte https://www.emailjs.com/
     * 2) Ajoute un service (SMTP relay / Gmail / autre)
     * 3) Crée un template avec les variables: to_emails, subject, message_html
     * 4) Remplace ci-dessous: SERVICE_ID, TEMPLATE_ID et la publicKey plus haut
     */
    const SERVICE_ID = "REMPLACE_AVEC_TON_SERVICE_ID";
    const TEMPLATE_ID = "REMPLACE_AVEC_TON_TEMPLATE_ID";

    async function envoyerEmails(){
      const dest = (document.getElementById('destinataires').value || "")
        .split(",")
        .map(s=>s.trim())
        .filter(Boolean);

      if(dest.length === 0){
        alert("Ajoute au moins un destinataire (séparés par des virgules).");
        return;
      }

      const subject = (document.getElementById('objet').value || "Synthèse des heures").trim();
      const html = buildEmailHtml(readRows());

      // eslint-disable-next-line no-undef
      const res = await emailjs.send(SERVICE_ID, TEMPLATE_ID, {
        to_emails: dest.join(","),
        subject,
        message_html: html
      });

      // Pastille → verte, pas de popup
      markSaved();
      // console.log("Emails envoyés:", res.status, res.text);
    }
    document.getElementById('btnEnvoyerMails').addEventListener('click', envoyerEmails);

    /*****************************************
     * Détection de modifs → pastille orange *
     *****************************************/
    document.getElementById('tableWrap').addEventListener('input', markDirty);
    document.getElementById('destinataires').addEventListener('input', markDirty);
    document.getElementById('objet').addEventListener('input', markDirty);

    /********************************************
     * Récup auto depuis localStorage à l’ouverture
     ********************************************/
    (function restore(){
      const raw = localStorage.getItem('diffusion_heures');
      if(!raw) return;
      try{
        const rows = JSON.parse(raw);
        if(Array.isArray(rows) && rows.length){
          renderTbody(rows);
          markSaved();
        }
      }catch(e){/* ignore */}
    })();
  </script>
</body>
</html>