<script>
// ...garde tout le reste inchangÃ©

/* ===================== DIFFUSION (PATCH) ===================== */
let dfSelected = new Set();

function renderDiffusionBadges(){
  const box = document.getElementById("df-agencies");
  box.innerHTML = "";
  data.agencies.forEach(a=>{
    const b = document.createElement("button");
    b.className = "badge";
    b.textContent = a.name;
    if (dfSelected.has(a.name)) b.style.background="#e0f2fe";
    b.onclick = ()=>{ dfSelected.has(a.name) ? dfSelected.delete(a.name) : dfSelected.add(a.name); renderDiffusionBadges(); };
    box.appendChild(b);
  });
  const rz = document.createElement("button");
  rz.className="badge"; rz.textContent="Tout";
  rz.onclick=()=>{ if(dfSelected.size===data.agencies.length) dfSelected.clear(); else dfSelected=new Set(data.agencies.map(a=>a.name)); renderDiffusionBadges(); };
  box.appendChild(rz);
}

function makeAgencyTableHTML(ag, wkKey, daysArr){
  const d0 = isoWeekStart(weekStart);
  // THEAD
  let head = `<thead><tr><th rowspan="2">Ouvrier</th><th class="col-week" colspan="${daysArr.length}">Semaine ${wkKey.split("-W")[1]}</th></tr><tr>`;
  daysArr.forEach((_,i)=>{
    const d=new Date(d0); d.setDate(d0.getDate()+i);
    head += `<th>${["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"][i]} ${("0"+d.getDate()).slice(-2)}/${("0"+(d.getMonth()+1)).slice(-2)}</th>`;
  });
  head += `</tr></thead>`;

  // Corps : 2 lignes par ouvrier
  const rows = data.rows.filter(r=>r.week===wkKey).map(r=>({r,w:data.ouvriers.find(o=>o.id===r.workerId)})).filter(x=>x.w && x.w.agency===ag);
  let body = "<tbody>";
  rows.forEach(({w,r},idx)=>{
    const cls = (idx%2===0) ? " class='alt'" : "";
    // Ligne Heures
    body += `<tr${cls}><td rowspan="2">${toTitleCaseHyphen(w.first)} ${toUpper(w.last)}</td>`;
    for (let i=0;i<daysArr.length;i++){
      const k = DAY_KEYS[i], h = r.days?.[k]?.h || 0;
      body += `<td>${h>0 ? String(h.toFixed(2)).replace(".",",") : ""}</td>`;
    }
    body += `</tr>`;
    // Ligne Chantier
    body += `<tr${cls}>`;
    for (let i=0;i<daysArr.length;i++){
      const k = DAY_KEYS[i], h = r.days?.[k]?.h || 0, c = r.days?.[k]?.chantier || "";
      body += `<td>${h>0 ? c : ""}</td>`;
    }
    body += `</tr>`;
  });
  body += "</tbody>";

  return `<table border="1" cellpadding="4" cellspacing="0" style="border-collapse:collapse;width:100%">${head}${body}</table>`;
}

function renderDiffusionTables(){
  const zone = document.getElementById("df-results");
  const mailZone = document.getElementById("df-mails");
  zone.innerHTML = ""; mailZone.innerHTML = "";

  // Semaine choisie
  const dSel = document.getElementById("df-week").value;
  const selectedDate = dSel ? new Date(dSel) : weekStart;
  weekStart = isoWeekStart(selectedDate); // on aligne lâ€™affichage
  const wk = toWeekKey(weekStart);
  const weekNo = wk.split("-W")[1];

  // Jours visibles (week-end option pris en compte)
  const days = (includeWeekend ? ["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"] : ["Lun","Mar","Mer","Jeu","Ven"]);
  const dayCount = days.length;

  // Agences Ã  afficher
  const agenciesToShow = (dfSelected.size ? [...dfSelected] : data.agencies.map(a=>a.name)).sort();

  agenciesToShow.forEach(ag=>{
    // lignes concernÃ©es
    const rows = data.rows.filter(r=>r.week===wk).map(r=>({r,w:data.ouvriers.find(o=>o.id===r.workerId)})).filter(x=>x.w && x.w.agency===ag);
    if (!rows.length) return; // nâ€™affiche pas dâ€™agence vide

    // TABLE visible
    const d0 = isoWeekStart(weekStart);
    const tbl = document.createElement("table");
    tbl.style.width="100%"; tbl.style.borderCollapse="collapse";
    const thead = document.createElement("thead");

    const tr1 = document.createElement("tr");
    const thName = document.createElement("th"); thName.rowSpan=2; thName.textContent="Ouvrier"; tr1.appendChild(thName);
    const thWeek = document.createElement("th"); thWeek.className="col-week"; thWeek.colSpan=dayCount; thWeek.textContent=`Semaine ${weekNo}`; tr1.appendChild(thWeek);
    thead.appendChild(tr1);

    const tr2 = document.createElement("tr");
    for (let i=0;i<dayCount;i++){
      const d=new Date(d0); d.setDate(d0.getDate()+i);
      const thd=document.createElement("th");
      thd.textContent = `${days[i]} ${("0"+d.getDate()).slice(-2)}/${("0"+(d.getMonth()+1)).slice(-2)}`;
      tr2.appendChild(thd);
    }
    thead.appendChild(tr2);
    tbl.appendChild(thead);

    const tbody = document.createElement("tbody");

    rows.forEach(({w,r},idx)=>{
      const trH=document.createElement("tr"), trC=document.createElement("tr");
      if (idx%2===0){ trH.className="alt"; trC.className="alt"; }

      const tdName=document.createElement("td");
      tdName.rowSpan=2; tdName.textContent=`${toTitleCaseHyphen(w.first)} ${toUpper(w.last)}`;
      trH.appendChild(tdName);

      // Heures (ligne 1)
      for (let i=0;i<dayCount;i++){
        const td=document.createElement("td");
        const k = DAY_KEYS[i], h = r.days?.[k]?.h || 0;
        td.textContent = h>0 ? String(h.toFixed(2)).replace(".",",") : "";
        trH.appendChild(td);
      }

      // Chantier (ligne 2)
      for (let i=0;i<dayCount;i++){
        const td=document.createElement("td");
        const k = DAY_KEYS[i], h = r.days?.[k]?.h || 0, c = r.days?.[k]?.chantier || "";
        td.textContent = h>0 ? c : "";
        trC.appendChild(td);
      }

      tbody.appendChild(trH);
      tbody.appendChild(trC);
    });

    tbl.appendChild(tbody);

    // Encapsule dans un panneau
    const wrap=document.createElement("div"); wrap.className="panel"; wrap.style.marginBottom="16px";
    const hd=document.createElement("div"); hd.className="hd"; hd.innerHTML=`<strong>${ag}</strong> â€” Semaine ${weekNo}`; wrap.appendChild(hd);
    const bd=document.createElement("div"); bd.className="bd"; bd.appendChild(tbl); wrap.appendChild(bd);
    zone.appendChild(wrap);

    // MAIL : mÃªme tableau (HTML) avec mÃªme jeu de jours
    const agencyObj = data.agencies.find(a=>a.name===ag);
    const htmlTable = makeAgencyTableHTML(ag, wk, days);
    const subject = encodeURIComponent(`Pointages - ${ag} - Semaine ${weekNo}`);
    const body = encodeURIComponent(htmlTable); // HTML encodÃ© (les clients mail afficheront souvent en texte, mais câ€™est beaucoup plus lisible)
    const href = `mailto:${encodeURIComponent(agencyObj?.email||"")}?subject=${subject}&body=${body}`;

    const link=document.createElement("a");
    link.className="badge"; link.href=href; link.textContent=`ðŸ“§ PrÃ©parer l'e-mail Ã  ${ag}`;
    mailZone.appendChild(link);
  });

  if (!zone.children.length){
    zone.innerHTML = '<div class="small">Aucune donnÃ©e pour cette sÃ©lection.</div>';
  }
}

document.getElementById("btn-df-generate")?.addEventListener("click", renderDiffusionTables);

// ...garde tout le reste inchangÃ©
</script>