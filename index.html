<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Suite chantier — Planning • Pointage • Diffusion • Ouvriers • Agences • Chantiers • Paramètres</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  :root{
    --bg:#0d1017; --panel:#141a24; --ink:#e9eef6; --muted:#a3afc2;
    --accent:#61a6ff; --ok:#34c759; --warn:#ff9f0a; --err:#ff453a; --line:#283040; --chip:#1a2130;
    --radius:14px; --shadow: 0 12px 30px rgba(0,0,0,.28);
    --font: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  html,body{height:100%}
  body{
    margin:0; color:var(--ink); font-family:var(--font);
    background: radial-gradient(1200px 700px at 10% 10%, #0f1624 0%, #0d1119 40%, #0b0f16 100%);
    -webkit-font-smoothing:antialiased;
  }
  a{color:inherit; text-decoration:none}
  .wrap{max-width:1380px; margin:24px auto 64px; padding:0 20px;}
  .header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px;}
  .title{font-size: clamp(20px, 2.6vw, 30px); font-weight:800; letter-spacing:.2px}
  .badge{display:inline-flex; align-items:center; gap:10px; padding:10px 14px; background:linear-gradient(180deg,#111827,#0f1522); border:1px solid var(--line); border-radius:999px; font-size:14px; color:#cfd7e6;}
  .dot{width:10px; height:10px; border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.25) inset;}
  .dot.orange{background:var(--warn)} .dot.green{background:var(--ok)}
  .nav{display:flex; gap:8px; background:linear-gradient(180deg,#131a28,#111827); border:1px solid var(--line); border-radius:999px; padding:6px; flex-wrap:wrap}
  .tab{padding:8px 14px; border-radius:999px; color:#cfe0ff; border:1px solid transparent}
  .tab.active{background:#24314e; border-color:#344468}
  .panel{background:linear-gradient(180deg,#121a2a,#101623); border:1px solid var(--line); border-radius:var(--radius); overflow:hidden; box-shadow: var(--shadow); margin-top:14px}
  .panel-h{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line);}
  .panel-b{padding:16px;}
  .toolbar{display:flex; flex-wrap:wrap; gap:10px}
  .btn{padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:#1b2435; color:#e8effb; font-size:14px; cursor:pointer; transition:.15s transform ease, .2s background ease; user-select:none;}
  .btn:hover{transform: translateY(-1px)} .btn.primary{background:linear-gradient(180deg,#2e6cff,#214fd3); border-color:#1e3ea8}
  .btn.ghost{background:transparent}
  .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
  .pill{display:inline-block; padding:5px 10px; border-radius:999px; font-size:12px; background:#161f31; border:1px solid var(--line); color:#cbd5e7;}
  .field{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  input[type="text"], input[type="email"], input[type="number"], select, textarea{
    background:#0e1422; color:#e9eef6; border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:14px;
  }
  textarea{width:100%; min-height:120px}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

  /* Tables */
  .table-wrap{width:100%; overflow:auto; border-radius:12px; border:1px solid var(--line);}
  table{width:100%; border-collapse:separate; border-spacing:0; min-width:980px; background:#0f141f}
  thead th{
    position:sticky; top:0; z-index:3;
    backdrop-filter: blur(6px); background:#0f141fe6; color:#d6def0;
    font-weight:700; text-align:left; font-size:12.5px; letter-spacing:.3px;
    border-bottom:1px solid var(--line); padding:10px 12px;
  }
  thead .th-group{font-size:12px; text-align:center; border-bottom:0}
  tbody td{border-bottom:1px solid var(--line); padding:9px 12px; font-size:14px; color:#e5e9f3; white-space:nowrap}
  tbody tr:hover{background:#121a2c}
  tfoot td{background:#0f141f; font-weight:600}
  table .sticky-col{
    position: sticky; left:0; z-index:2; background:linear-gradient(180deg,#0f1523,#0d121d);
    border-right:1px solid var(--line);
  }
  .dayhead{writing-mode:vertical-rl; transform:rotate(180deg); font-size:11px; white-space:nowrap; color:#b9c7e1}
  .weekhead{font-weight:700; text-align:center}
  .cell-tag{display:inline-block; padding:4px 6px; border-radius:6px; background:#0f1a2b; border:1px solid var(--line); font-size:12px}
  .pcell{display:flex; flex-direction:column; gap:6px; min-width:140px}
  .pcell select{width:100%}
  .form-vert .row{display:flex; flex-direction:column; margin-bottom:10px}
  .form-vert label{font-size:12px; color:#cbd5e7; margin-bottom:6px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">Suite chantier — Suivi global</div>
      <nav class="nav" id="nav">
        <a href="#/planning"   class="tab" data-route="/planning">Planning</a>
        <a href="#/pointage"   class="tab" data-route="/pointage">Pointage</a>
        <a href="#/diffusion"  class="tab" data-route="/diffusion">Diffusion</a>
        <a href="#/ouvriers"   class="tab" data-route="/ouvriers">Ouvriers</a>
        <a href="#/agences"    class="tab" data-route="/agences">Agences</a>
        <a href="#/chantiers"  class="tab" data-route="/chantiers">Chantiers</a>
        <a href="#/parametres" class="tab" data-route="/parametres">Paramètres</a>
      </nav>
      <div class="badge" id="saveBadge">
        <span class="dot orange" id="saveDot"></span>
        <span id="saveText">Modifications non enregistrées</span>
      </div>
    </div>
    <main id="page"></main>
  </div>

  <!-- Modal de confirmation -->
  <div class="modal-backdrop" id="confirmModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); align-items:center; justify-content:center;">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" style="background:#0f141f; border:1px solid var(--line); border-radius:14px; max-width:520px; width:92%; box-shadow:var(--shadow);">
      <div class="m-h" id="confirmTitle" style="padding:16px; border-bottom:1px solid var(--line); font-weight:700">Enregistrer les modifications ?</div>
      <div class="m-b" style="padding:16px; color:#cbd5e7">Tu as des modifications non enregistrées.</div>
      <div class="m-f" style="padding:12px 16px; display:flex; gap:8px; justify-content:flex-end;">
        <button class="btn" id="btnKeep">Continuer sans enregistrer</button>
        <button class="btn primary" id="btnSaveAndGo">Enregistrer et continuer</button>
        <button class="btn ghost" id="btnCancelNav">Annuler</button>
      </div>
    </div>
  </div>

<script type="module">
/* =========================
   ROUTER & STATE
   ========================= */
const pageRoot = document.getElementById('page');
const routes = {
  '/planning': renderPlanningDailyReadOnly,
  '/pointage': renderPointageWeekly,
  '/diffusion': renderDiffusionParAgence,
  '/ouvriers': renderOuvriers,
  '/agences': renderAgences,
  '/chantiers': renderChantiers,
  '/parametres': renderParametres,
};
const dirtyState = Object.fromEntries(Object.keys(routes).map(r=>[r,false]));
let currentRoute = '/planning', pendingRoute = null;
const modal = document.getElementById('confirmModal');
const btnKeep = document.getElementById('btnKeep');
const btnSaveAndGo = document.getElementById('btnSaveAndGo');
const btnCancelNav = document.getElementById('btnCancelNav');
const saveHandlers = {}; // callbacks d'enregistrement par page

function setDirty(route, isDirty){ dirtyState[route] = !!isDirty; updateBadge(); }
function updateBadge(){
  const dot = document.getElementById('saveDot');
  const text = document.getElementById('saveText');
  if(dirtyState[currentRoute]){ dot.classList.remove('green'); dot.classList.add('orange'); text.textContent = "Modifications non enregistrées"; }
  else { dot.classList.remove('orange'); dot.classList.add('green'); text.textContent = "Enregistré"; }
}
function activateTab(route){ document.querySelectorAll('.tab').forEach(a=>a.classList.toggle('active', a.dataset.route === route)); }
function showConfirm(){ modal.style.display='flex'; }
function hideConfirm(){ modal.style.display='none'; }
btnCancelNav.addEventListener('click', ()=>{ pendingRoute=null; hideConfirm(); });
btnKeep.addEventListener('click', ()=>{ hideConfirm(); navigate(pendingRoute, {force:true}); pendingRoute=null; });
btnSaveAndGo.addEventListener('click', async ()=>{ hideConfirm(); await saveHandlers[currentRoute]?.(); navigate(pendingRoute, {force:true}); pendingRoute=null; });
window.addEventListener('beforeunload', (e)=>{ if(dirtyState[currentRoute]){ e.preventDefault(); e.returnValue=''; } });

function navigate(route, opts={}){
  if(!routes[route]) route='/planning';
  if(!opts.force && dirtyState[currentRoute]){ pendingRoute = route; showConfirm(); return; }
  currentRoute = route; window.location.hash = '#'+route; activateTab(route);
  routes[route](); updateBadge();
}
function handleHash(){
  const hash = window.location.hash.replace(/^#/, '') || '/planning';
  if(hash !== currentRoute){ navigate(hash); } else { navigate(currentRoute, {force:true}); }
}
window.addEventListener('hashchange', handleHash);
document.addEventListener('DOMContentLoaded', handleHash);

/* =========
   STORAGE
   ========= */
const storage = {
  get(k, fb){ try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? fb; }catch{ return fb; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
};
const KEYS = {
  ouvriers:  'app_ouvriers_v11',
  agences:   'app_agences_v11',
  chantiers: 'app_chantiers_v11',
  pointage:  'app_pointage_v11',   // {date, ouvrier, agence, chantier, heures}
  params:    'app_params_v11',
};

/* =========
   DEFAULTS
   ========= */
const DEFAULT_OUVRIERS = [
  { prenom:"Baudouin", nom:"RIBERON", metier:"Plâquiste",  qualification:"N3P1", agence:"SAMSIC" },
  { prenom:"Laurent",  nom:"JOLY",    metier:"Plombier",   qualification:"N3P2", agence:"BPS" },
  { prenom:"Jean-Marc",nom:"GOUZY",   metier:"Polyvalent", qualification:"N4P1", agence:"SAMSIC" },
];
const DEFAULT_AGENCES = [
  { nom:"SAMSIC", email:"samsic@exemple.com" },
  { nom:"BPS",    email:"bps@exemple.com" },
  { nom:"SOVITRAT", email:"sovitrat@exemple.com" },
];
const DEFAULT_CHANTIERS = [
  { code:"M96 W19S", numDA:"", nomDA:"", encadrant:"Alexis", adresse:"", zone:"" },
  { code:"M91 N10S", numDA:"", nomDA:"", encadrant:"Jérémy", adresse:"", zone:"" },
  { code:"M65 W01S", numDA:"", nomDA:"", encadrant:"Paul",   adresse:"", zone:"" },
];
const DEFAULT_PARAMS = { qualifs:["N1","N2","N3P1","N3P2","N4P1","N4P2"] };

/* =========
   UTILS — LOCAL (lundi=1…dimanche=0)
   ========= */
function escapeHtml(s=""){ return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
function formatHeuresFR(v){ const n = Number(v??0); return `${n.toFixed(2).replace(".",",")} Heures`; }
function formatHeuresShort(v){ const n = Number(v??0); return n.toFixed(2).replace(".",","); }
function fullName(o){ return `${o.prenom} ${o.nom}`.trim(); }
function toYMDLocal(d){ const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function getISOWeekLocal(d){ const date=new Date(d.getFullYear(), d.getMonth(), d.getDate()); let day=date.getDay(); if(day===0) day=7; date.setDate(date.getDate()+4-day); const yearStart=new Date(date.getFullYear(),0,1); const diffDays=Math.floor((date-yearStart)/86400000)+1; return {year:date.getFullYear(), week:Math.ceil(diffDays/7)}; }
function weekDatesLocal(year, week){ const simple=new Date(year,0,4); let day=simple.getDay(); if(day===0) day=7; const monday=new Date(simple); monday.setDate(simple.getDate()-day+1+(week-1)*7); return [...Array(7)].map((_,i)=>{ const d=new Date(monday); d.setDate(monday.getDate()+i); return toYMDLocal(d); }); }
function weekdaysOfYearLocal(year){ const start=new Date(year,0,1), end=new Date(year+1,0,1), out=[]; for(let d=new Date(start); d<end; d.setDate(d.getDate()+1)){ let wd=d.getDay(); if(wd===0) wd=7; if(wd>=1 && wd<=5) out.push(new Date(d)); } return out; }
function niceDayLabel(iso){ const [y,m,da]=iso.split('-').map(Number); const d=new Date(y,m-1,da); return d.toLocaleDateString('fr-FR',{weekday:'short', day:'2-digit', month:'2-digit'}); }

/* =================
   OUVRIERS — FORM vertical
   ================= */
function renderOuvriers(){
  const route='/ouvriers';
  const params = storage.get(KEYS.params, DEFAULT_PARAMS);
  const agences = storage.get(KEYS.agences, DEFAULT_AGENCES).map(a=>a.nom);
  const rows = storage.get(KEYS.ouvriers, DEFAULT_OUVRIERS);

  pageRoot.innerHTML = `
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Ouvriers — Ajouter & Récap</span></div>
        <div class="toolbar"><button class="btn" id="save">Enregistrer</button></div>
      </div>
      <div class="panel-b">
        <div class="form-vert" style="max-width:520px; margin-bottom:14px">
          <div class="row"><label>Prénom</label><input id="iPrenom" type="text" /></div>
          <div class="row"><label>Nom</label><input id="iNom" type="text" /></div>
          <div class="row"><label>Métier</label><input id="iMetier" type="text" /></div>
          <div class="row"><label>Qualification</label><select id="iQualif">${params.qualifs.map(q=>`<option>${q}</option>`).join('')}</select></div>
          <div class="row"><label>Agence</label><select id="iAgence">${agences.map(a=>`<option>${a}</option>`).join('')}</select></div>
          <div class="row"><button class="btn primary" id="add">Ajouter l'ouvrier</button></div>
        </div>

        <div class="table-wrap">
          <table>
            <thead><tr><th class="sticky-col">Prénom</th><th>Nom</th><th>Métier</th><th>Qualification</th><th>Agence</th><th></th></tr></thead>
            <tbody id="tb"></tbody>
          </table>
        </div>
      </div>
    </section>
  `;
  const tb=document.getElementById('tb');
  function rowTpl(r,i){
    return `<tr data-i="${i}">
      <td class="sticky-col" contenteditable data-k="prenom">${escapeHtml(r.prenom)}</td>
      <td contenteditable data-k="nom">${escapeHtml(r.nom)}</td>
      <td contenteditable data-k="metier">${escapeHtml(r.metier||"")}</td>
      <td contenteditable data-k="qualification">${escapeHtml(r.qualification||"")}</td>
      <td contenteditable data-k="agence">${escapeHtml(r.agence||"")}</td>
      <td><button class="btn ghost del">Suppr.</button></td>
    </tr>`;
  }
  function render(){ tb.innerHTML = rows.map(rowTpl).join(''); bind(); }
  function bind(){
    tb.querySelectorAll('[contenteditable]').forEach(el=>el.addEventListener('input', ()=> setDirty(route,true)));
    tb.querySelectorAll('.del').forEach(b=>b.addEventListener('click', e=>{
      const tr=e.target.closest('tr'); const i=+tr.dataset.i; rows.splice(i,1); render(); setDirty(route,true);
    }));
  }
  document.getElementById('add').addEventListener('click', ()=>{
    const prenom = document.getElementById('iPrenom').value.trim();
    const nom    = document.getElementById('iNom').value.trim();
    if(!prenom || !nom) { alert("Prénom et Nom requis"); return; }
    rows.push({ prenom, nom,
      metier: document.getElementById('iMetier').value.trim(),
      qualification: document.getElementById('iQualif').value,
      agence: document.getElementById('iAgence').value });
    render(); setDirty(route,true);
  });
  async function save(){
    const out=[]; tb.querySelectorAll('tr').forEach(tr=>{
      out.push({
        prenom:(tr.querySelector('[data-k="prenom"]')?.textContent||"").trim(),
        nom:(tr.querySelector('[data-k="nom"]')?.textContent||"").trim(),
        metier:(tr.querySelector('[data-k="metier"]')?.textContent||"").trim(),
        qualification:(tr.querySelector('[data-k="qualification"]')?.textContent||"").trim(),
        agence:(tr.querySelector('[data-k="agence"]')?.textContent||"").trim(),
      });
    });
    storage.set(KEYS.ouvriers,out); setDirty(route,false);
  }
  saveHandlers[route]=save; document.getElementById('save').addEventListener('click', save);
  render(); setDirty(route,false);
}

/* =================
   AGENCES — FORM vertical
   ================= */
function renderAgences(){
  const route='/agences';
  const rows = storage.get(KEYS.agences, DEFAULT_AGENCES);
  pageRoot.innerHTML=`
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Agences — Ajouter & Récap</span></div>
        <div class="toolbar"><button class="btn" id="save">Enregistrer</button></div>
      </div>
      <div class="panel-b">
        <div class="form-vert" style="max-width:520px; margin-bottom:14px">
          <div class="row"><label>Nom</label><input id="aNom" type="text" /></div>
          <div class="row"><label>Email(s)</label><input id="aEmail" type="email" placeholder="plusieurs séparés par des virgules"/></div>
          <div class="row"><button class="btn primary" id="add">Ajouter l'agence</button></div>
        </div>

        <div class="table-wrap">
          <table>
            <thead><tr><th class="sticky-col">Nom</th><th>Email(s)</th><th></th></tr></thead>
            <tbody id="tb"></tbody>
          </table>
        </div>
      </div>
    </section>
  `;
  const tb=document.getElementById('tb');
  function rowTpl(r,i){ return `<tr data-i="${i}">
    <td class="sticky-col" contenteditable data-k="nom">${escapeHtml(r.nom)}</td>
    <td contenteditable data-k="email">${escapeHtml(r.email||"")}</td>
    <td><button class="btn ghost del">Suppr.</button></td>
  </tr>`;}
  function render(){ tb.innerHTML=rows.map(rowTpl).join(''); bind(); }
  function bind(){
    tb.querySelectorAll('[contenteditable]').forEach(el=>el.addEventListener('input',()=>setDirty(route,true)));
    tb.querySelectorAll('.del').forEach(b=>b.addEventListener('click',e=>{
      const tr=e.target.closest('tr'); const i=+tr.dataset.i; rows.splice(i,1); render(); setDirty(route,true);
    }));
  }
  document.getElementById('add').addEventListener('click',()=>{
    const nom=document.getElementById('aNom').value.trim();
    if(!nom){ alert("Nom requis"); return; }
    rows.push({nom, email: document.getElementById('aEmail').value.trim()});
    render(); setDirty(route,true);
  });
  async function save(){
    const out=[]; tb.querySelectorAll('tr').forEach(tr=>{
      out.push({ nom:(tr.querySelector('[data-k="nom"]')?.textContent||"").trim(),
                 email:(tr.querySelector('[data-k="email"]')?.textContent||"").trim() });
    });
    storage.set(KEYS.agences,out); setDirty(route,false);
  }
  saveHandlers[route]=save; document.getElementById('save').addEventListener('click', save);
  render(); setDirty(route,false);
}

/* =================
   CHANTIERS — FORM vertical
   ================= */
function renderChantiers(){
  const route='/chantiers';
  const rows = storage.get(KEYS.chantiers, DEFAULT_CHANTIERS);
  pageRoot.innerHTML=`
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Chantiers — Ajouter & Récap</span></div>
        <div class="toolbar"><button class="btn" id="save">Enregistrer</button></div>
      </div>
      <div class="panel-b">
        <div class="form-vert" style="max-width:520px; margin-bottom:14px">
          <div class="row"><label>Code</label><input id="cCode" type="text" /></div>
          <div class="row"><label>Numéro DA</label><input id="cDA" type="text" /></div>
          <div class="row"><label>Nom DA</label><input id="cNomDA" type="text" /></div>
          <div class="row"><label>Encadrant</label><input id="cEnc" type="text" /></div>
          <div class="row"><label>Adresse</label><input id="cAdr" type="text" /></div>
          <div class="row"><label>Zone</label><input id="cZone" type="text" /></div>
          <div class="row"><button class="btn primary" id="add">Ajouter le chantier</button></div>
        </div>

        <div class="table-wrap">
          <table>
            <thead><tr><th class="sticky-col">Code</th><th>Numéro DA</th><th>Nom DA</th><th>Encadrant</th><th>Adresse</th><th>Zone</th><th></th></tr></thead>
            <tbody id="tb"></tbody>
          </table>
        </div>
      </div>
    </section>
  `;
  const tb=document.getElementById('tb');
  function rowTpl(r,i){ return `<tr data-i="${i}">
    <td class="sticky-col" contenteditable data-k="code">${escapeHtml(r.code)}</td>
    <td contenteditable data-k="numDA">${escapeHtml(r.numDA||"")}</td>
    <td contenteditable data-k="nomDA">${escapeHtml(r.nomDA||"")}</td>
    <td contenteditable data-k="encadrant">${escapeHtml(r.encadrant||"")}</td>
    <td contenteditable data-k="adresse">${escapeHtml(r.adresse||"")}</td>
    <td contenteditable data-k="zone">${escapeHtml(r.zone||"")}</td>
    <td><button class="btn ghost del">Suppr.</button></td>
  </tr>`;}
  function render(){ tb.innerHTML=rows.map(rowTpl).join(''); bind(); }
  function bind(){
    tb.querySelectorAll('[contenteditable]').forEach(el=>el.addEventListener('input',()=>setDirty(route,true)));
    tb.querySelectorAll('.del').forEach(b=>b.addEventListener('click',e=>{
      const tr=e.target.closest('tr'); const i=+tr.dataset.i; rows.splice(i,1); render(); setDirty(route,true);
    }));
  }
  document.getElementById('add').addEventListener('click',()=>{
    const code=document.getElementById('cCode').value.trim();
    if(!code){ alert("Code requis"); return; }
    rows.push({
      code,
      numDA: document.getElementById('cDA').value.trim(),
      nomDA: document.getElementById('cNomDA').value.trim(),
      encadrant: document.getElementById('cEnc').value.trim(),
      adresse: document.getElementById('cAdr').value.trim(),
      zone: document.getElementById('cZone').value.trim(),
    });
    render(); setDirty(route,true);
  });
  async function save(){
    const out=[]; tb.querySelectorAll('tr').forEach(tr=>{
      out.push({
        code:(tr.querySelector('[data-k="code"]')?.textContent||"").trim(),
        numDA:(tr.querySelector('[data-k="numDA"]')?.textContent||"").trim(),
        nomDA:(tr.querySelector('[data-k="nomDA"]')?.textContent||"").trim(),
        encadrant:(tr.querySelector('[data-k="encadrant"]')?.textContent||"").trim(),
        adresse:(tr.querySelector('[data-k="adresse"]')?.textContent||"").trim(),
        zone:(tr.querySelector('[data-k="zone"]')?.textContent||"").trim(),
      });
    });
    storage.set(KEYS.chantiers,out); setDirty(route,false);
  }
  saveHandlers[route]=save; document.getElementById('save').addEventListener('click', save);
  render(); setDirty(route,false);
}

/* =================
   PLANNING — READ-ONLY (toute l’année, L→V)
   ================= */
function renderPlanningDailyReadOnly(){
  const route='/planning';
  const ouvriers = storage.get(KEYS.ouvriers, DEFAULT_OUVRIERS);
  const pointage = storage.get(KEYS.pointage, []);
  const currentYear = new Date().getFullYear();
  const years = Array.from({length:5},(_,i)=>currentYear-2+i);
  const ySel = parseInt(new URLSearchParams(location.hash.split('?')[1]).get('year') || currentYear, 10);
  const days = weekdaysOfYearLocal(ySel);

  // index pointage -> map[ouvrier][yyyy-mm-dd] = {h, c}
  const map = {};
  const y0 = new Date(ySel,0,1);
  const y1 = new Date(ySel+1,0,1);
  pointage.forEach(r=>{
    const [Y,M,D] = (r.date||'').split('-').map(Number);
    if(!Y) return;
    const d = new Date(Y, M-1, D);
    if(d >= y0 && d < y1){
      (map[r.ouvrier] ||= {})[r.date] = { h:+(r.heures||0), c:r.chantier||"" };
    }
  });

  // Entêtes groupées par semaines
  const weeks = []; // {week, count, dates[]}
  let cur=null;
  days.forEach(d=>{
    const {week} = getISOWeekLocal(d);
    const iso = toYMDLocal(d);
    if(!cur || cur.week!==week){ cur = {week, count:0, dates:[]}; weeks.push(cur); }
    cur.count++; cur.dates.push(iso);
  });

  pageRoot.innerHTML = `
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Planning — ${ySel} (Lundi → Vendredi)</span></div>
        <div class="toolbar">
          <label class="pill">Année</label>
          <select id="yearSel">${years.map(y=>`<option ${y===ySel?'selected':''}>${y}</option>`).join('')}</select>
        </div>
      </div>
      <div class="panel-b">
        <div class="table-wrap">
          <table id="planTbl" style="min-width:1400px">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  `;

  const thead = document.getElementById('thead');
  const tbody = document.getElementById('tbody');

  const thWeeks = `<tr class="th-group"><th class="sticky-col"></th>${
    weeks.map(w=>`<th class="weekhead" colspan="${w.count}">S${w.week}</th>`).join('')
  }</tr>`;
  const thDays = `<tr><th class="sticky-col">Ouvrier</th>${
    weeks.map(w => w.dates.map(iso=>`<th><div class="dayhead">${escapeHtml(niceDayLabel(iso))}</div></th>`).join('')).join('')
  }</tr>`;
  thead.innerHTML = thWeeks + thDays;

  ouvriers.forEach(o=>{
    const name = fullName(o);
    let row1 = `<tr><td class="sticky-col mono" rowspan="2">${escapeHtml(name)}</td>`;
    weeks.forEach(w=>{
      w.dates.forEach(iso=>{
        const rec = map[name]?.[iso];
        row1 += `<td class="mono">${rec?.h ? escapeHtml(formatHeuresShort(rec.h)) : ''}</td>`;
      });
    });
    row1 += `</tr>`;
    let row2 = `<tr>`;
    weeks.forEach(w=>{
      w.dates.forEach(iso=>{
        const rec = map[name]?.[iso];
        row2 += `<td>${rec?.c ? `<span class="cell-tag">${escapeHtml(rec.c)}</span>` : ''}</td>`;
      });
    });
    row2 += `</tr>`;
    tbody.insertAdjacentHTML('beforeend', row1 + row2);
  });

  document.getElementById('yearSel').addEventListener('change', ()=>{
    const y = document.getElementById('yearSel').value;
    location.hash = `#/planning?year=${encodeURIComponent(y)}`;
  });

  setDirty(route,false);
}

/* =================
   POINTAGE — HEBDO (autosave)
   ================= */
function renderPointageWeekly(){
  const route='/pointage';
  const ouvriers = storage.get(KEYS.ouvriers, DEFAULT_OUVRIERS).map(o=>({ ...o, nomComplet: fullName(o) }));
  const {year:curY, week:curW} = getISOWeekLocal(new Date());

  pageRoot.innerHTML = `
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Pointage — Semaine</span></div>
        <div class="toolbar">
          <div class="field">
            <label class="pill">Année</label><input type="number" id="pYear" value="${curY}" style="width:110px"/>
            <label class="pill">Semaine</label>
            <select id="pWeek" style="width:110px">${Array.from({length:53},(_,i)=>`<option value="${i+1}" ${i+1===curW?'selected':''}>${i+1}</option>`).join('')}</select>
          </div>
          <button class="btn" id="save">Enregistrer</button>
        </div>
      </div>
      <div class="panel-b">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th class="sticky-col">Ouvrier</th>
                <th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th>
                <th>Total</th>
                <th>Auto (heures)</th>
              </tr>
            </thead>
            <tbody id="tb"></tbody>
            <tfoot>
              <tr>
                <td class="sticky-col" style="font-weight:700">Total jour (heures)</td>
                <td class="mono" id="totLun">0.00</td>
                <td class="mono" id="totMar">0.00</td>
                <td class="mono" id="totMer">0.00</td>
                <td class="mono" id="totJeu">0.00</td>
                <td class="mono" id="totVen">0.00</td>
                <td class="mono" id="totSem" colspan="2">0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </section>
  `;

  const pYear = document.getElementById('pYear');
  const pWeek = document.getElementById('pWeek');
  const tb    = document.getElementById('tb');

  function hoursOptions(selVal){
    const opts=[]; for(let v=0; v<=10; v+=0.5){ const sel=(+v===+selVal)?'selected':''; opts.push(`<option value="${v.toFixed(1)}" ${sel}>${v.toFixed(1)}</option>`); }
    return opts.join('');
  }
  function chantierOptions(selVal){
    const list = storage.get(KEYS.chantiers, DEFAULT_CHANTIERS).map(c=>c.code);
    return `<option value=""></option>` + list.map(c=>`<option ${c===selVal?'selected':''}>${c}</option>`).join('');
  }
  function daysForWeek(year, week){ return weekDatesLocal(year, week).slice(0,5); } // Lundi..Vendredi
  function getMapForWeek(year, week){
    const dates = daysForWeek(year, week);
    const map = new Map(); // name -> {jours:[{h,c},...]}
    ouvriers.forEach(o=> map.set(o.nomComplet, { worker:o, jours:dates.map(()=>({h:0,c:""})) }));
    storage.get(KEYS.pointage, []).filter(r=> dates.includes(r.date)).forEach(r=>{
      const idx = dates.indexOf(r.date); const ref = map.get(r.ouvrier);
      if(ref){ ref.jours[idx] = { h:(+r.heures||0), c:(r.chantier||"") }; }
    });
    return {map, dates};
  }
  function persistWeek(year, week){
    const dates = daysForWeek(year, week);
    const keep = storage.get(KEYS.pointage, []).filter(r=> !dates.includes(r.date));
    document.querySelectorAll('tr[data-worker]').forEach(tr=>{
      const ouvrier = tr.dataset.worker;
      const agence = (storage.get(KEYS.ouvriers, DEFAULT_OUVRIERS).find(o=>fullName(o)===ouvrier)?.agence)||"";
      tr.querySelectorAll('.pcell').forEach((cell,dayIdx)=>{
        const h = +cell.querySelector('.hsel').value || 0;
        const c = (cell.querySelector('.csel').value || "").trim();
        if(h>0 || c){
          keep.push({ date: dates[dayIdx], ouvrier, agence, chantier: c, heures: h });
        }
      });
    });
    storage.set(KEYS.pointage, keep);
  }
  function renderTable(){
    const year = parseInt(pYear.value,10);
    const week = parseInt(pWeek.value,10);
    const { map } = getMapForWeek(year, week);

    tb.innerHTML = [...map.values()].map(({worker, jours})=>{
      const total = jours.reduce((s,j)=>s+(+j.h||0),0);
      return `<tr data-worker="${escapeHtml(worker.nomComplet)}">
        <td class="sticky-col mono">${escapeHtml(worker.nomComplet)}</td>
        ${jours.map((j,idx)=>`
          <td>
            <div class="pcell">
              <select class="hsel" data-day="${idx}">${hoursOptions(j.h)}</select>
              <select class="csel" data-day="${idx}">${chantierOptions(j.c)}</select>
            </div>
          </td>
        `).join('')}
        <td class="mono rowTotal">${total.toFixed(2)}</td>
        <td><button class="btn ghost autoOne">Auto</button></td>
      </tr>`;
    }).join('');

    bindRowEvents();
    recomputeTotals();
  }
  function bindRowEvents(){
    const curYear = ()=>parseInt(pYear.value,10);
    const curWeek = ()=>parseInt(pWeek.value,10);

    tb.querySelectorAll('select.hsel').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        const y=curYear(), w=curWeek();
        const tr = sel.closest('tr');
        const vals = [...tr.querySelectorAll('select.hsel')].map(s=>+s.value||0);
        tr.querySelector('.rowTotal').textContent = vals.reduce((s,h)=>s+h,0).toFixed(2);
        persistWeek(y,w);
        setDirty('/pointage', true);
        recomputeTotals();
      });
    });
    tb.querySelectorAll('select.csel').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        const y=curYear(), w=curWeek();
        persistWeek(y,w);
        setDirty('/pointage', true);
      });
    });
    tb.querySelectorAll('.autoOne').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tr = btn.closest('tr');
        const selects = [...tr.querySelectorAll('select.hsel')];
        selects.forEach((s,idx)=>{ s.value = (idx<4 ? 7.5 : 7.0).toFixed(1); s.dispatchEvent(new Event('change')); });
      });
    });
  }
  function recomputeTotals(){
    const idxs=[0,1,2,3,4];
    const colTotals = idxs.map(i=>{
      let sum=0; document.querySelectorAll(`select.hsel[data-day="${i}"]`).forEach(s=> sum += (+s.value||0)); return sum;
    });
    document.getElementById('totLun').textContent = colTotals[0].toFixed(2);
    document.getElementById('totMar').textContent = colTotals[1].toFixed(2);
    document.getElementById('totMer').textContent = colTotals[2].toFixed(2);
    document.getElementById('totJeu').textContent = colTotals[3].toFixed(2);
    document.getElementById('totVen').textContent = colTotals[4].toFixed(2);
    const totSem = colTotals.reduce((s,x)=>s+x,0);
    document.getElementById('totSem').textContent = totSem.toFixed(2);
  }
  async function save(){
    const y=parseInt(pYear.value,10), w=parseInt(pWeek.value,10);
    persistWeek(y,w);
    setDirty(route,false);
  }
  saveHandlers[route]=save;
  document.getElementById('save').addEventListener('click', save);

  // Persister avant changement de semaine/année
  let lastYear = parseInt(pYear.value,10);
  let lastWeek = parseInt(pWeek.value,10);
  pYear.addEventListener('focus', ()=>{ lastYear = parseInt(pYear.value,10); });
  pWeek.addEventListener('focus', ()=>{ lastWeek = parseInt(pWeek.value,10); });
  pYear.addEventListener('change', ()=>{ persistWeek(lastYear, lastWeek); setDirty(route,false); lastYear = parseInt(pYear.value,10); renderTable(); });
  pWeek.addEventListener('change', ()=>{ persistWeek(lastYear, lastWeek); setDirty(route,false); lastWeek = parseInt(pWeek.value,10); renderTable(); });

  renderTable();
  setDirty(route,false);
}

/* =================
   DIFFUSION — mails HTML (tableau stylé) par agence
   ================= */
function renderDiffusionParAgence(){
  const route='/diffusion';
  const agencesObj = storage.get(KEYS.agences, DEFAULT_AGENCES);
  const {year:curY, week:curW} = getISOWeekLocal(new Date());

  pageRoot.innerHTML = `
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Diffusion — par Agence (jour par jour)</span></div>
        <div class="toolbar">
          <div class="field">
            <label class="pill">Année</label>
            <input type="number" id="dYear" value="${curY}" style="width:110px"/>
            <label class="pill">Semaine</label>
            <select id="dWeek" style="width:110px">${Array.from({length:53},(_,i)=>`<option value="${i+1}" ${i+1===curW?'selected':''}>${i+1}</option>`).join('')}</select>
          </div>
          <button class="btn" id="save">Enregistrer</button>
          <button class="btn primary" id="send">Envoyer (ouvrir Outlook)</button>
        </div>
      </div>
      <div class="panel-b">
        <div class="form-vert" style="margin-bottom:10px">
          <div class="row"><label>Agences à contacter</label>
            <div id="agList" class="field" style="gap:14px; flex-wrap:wrap"></div>
          </div>
        </div>
        <div id="tables"></div>
      </div>
    </section>
  `;

  const dYear = document.getElementById('dYear');
  const dWeek = document.getElementById('dWeek');
  const tablesDiv = document.getElementById('tables');
  const agListDiv = document.getElementById('agList');

  agListDiv.innerHTML = agencesObj.map(a=>{
    const safe = escapeHtml(a.nom);
    return `<label style="display:flex;align-items:center;gap:6px;border:1px solid var(--line);padding:6px 10px;border-radius:10px;background:#101526">
      <input type="checkbox" class="agChk" value="${safe}" checked />
      <span>${safe}</span>
      <span style="opacity:.7">(${escapeHtml(a.email||'—')})</span>
    </label>`;
  }).join('');

  function weekDates(year, week){ return weekDatesLocal(year, week).slice(0,5); } // Lun→Ven
  function groupData(){
    const year = parseInt(dYear.value,10);
    const week = parseInt(dWeek.value,10);
    const weekIsoDates = weekDates(year, week);
    const rows = storage.get(KEYS.pointage, []).filter(r=>weekIsoDates.includes(r.date));

    const byAgency = {};
    rows.forEach(r=>{
      const ag = r.agence || '—';
      byAgency[ag] = byAgency[ag] || {};
      const worker = r.ouvrier;
      byAgency[ag][worker] = byAgency[ag][worker] || { d:{}, total:0 };
      byAgency[ag][worker].d[r.date] = { h:+(r.heures||0), c:r.chantier||"" };
      byAgency[ag][worker].total += (+r.heures||0);
    });
    return { byAgency, weekIsoDates };
  }

  // --- HTML email builder (styles inline pour compatibilité Outlook) ---
  function buildHtmlEmail(agName){
    const { byAgency, weekIsoDates } = groupData();
    const recs = byAgency[agName] || {};
    const workers = Object.keys(recs).sort();

    const cols = ['Ouvrier', ...weekIsoDates.map(niceDayLabel), 'Total'];
    const head = cols.map(h=>`<th style="padding:10px 12px; font-weight:700; text-align:left; border-bottom:1px solid #d0d7e2;">${escapeHtml(h)}</th>`).join('');
    const rows = workers.map(w=>{
      const rec = recs[w];
      const tds = weekIsoDates.map(iso=>{
        const d = rec.d[iso];
        if(!d) return `<td style="padding:10px 12px; border-bottom:1px solid #eef1f6;">—</td>`;
        const cell = `${formatHeuresShort(d.h)} Heures${d.c?` — ${escapeHtml(d.c)}`:''}`;
        return `<td style="padding:10px 12px; border-bottom:1px solid #eef1f6;">${cell}</td>`;
      }).join('');
      return `<tr>
        <td style="padding:10px 12px; border-bottom:1px solid #eef1f6; font-weight:600;">${escapeHtml(w)}</td>
        ${tds}
        <td style="padding:10px 12px; border-bottom:1px solid #eef1f6; font-weight:600;">${formatHeuresShort(rec.total)} Heures</td>
      </tr>`;
    }).join('');

    const title = `Semaine ${dWeek.value}/${dYear.value} — ${escapeHtml(agName)}`;

    // Table container avec “carte” sombre claire (couleurs sobres pour Outlook)
    const html = `
<!doctype html>
<html>
  <body style="margin:0; padding:0; background:#f5f7fb; font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:#0b1220;">
    <div style="padding:20px;">
      <div style="max-width:940px; margin:0 auto; background:#0f141f; color:#e9eef6; border-radius:14px; border:1px solid #334158;">
        <div style="padding:14px 16px; border-bottom:1px solid #334158; font-weight:700;">${title}</div>
        <div style="padding:12px 16px;">
          <table role="table" cellpadding="0" cellspacing="0" border="0" style="width:100%; border-collapse:separate; border-spacing:0; background:#111727; color:#e9eef6; border:1px solid #334158; border-radius:12px; overflow:hidden;">
            <thead style="background:#0f1523; color:#d6def0;">
              <tr>${head}</tr>
            </thead>
            <tbody>${rows || `<tr><td colspan="${cols.length}" style="padding:12px; color:#cbd5e7;">Aucune donnée</td></tr>`}</tbody>
          </table>
        </div>
      </div>
      <div style="height:16px"></div>
      <div style="font-size:12px; color:#5b6a85">Email généré automatiquement.</div>
    </div>
  </body>
</html>`;
    return html;
  }

  function renderTables(){
    const { byAgency, weekIsoDates } = groupData();
    const agencies = Object.keys(byAgency).sort();
    if(agencies.length===0){ tablesDiv.innerHTML = `<p style="opacity:.8">Aucune donnée pour cette semaine.</p>`; return; }

    tablesDiv.innerHTML = agencies.map(ag=>{
      const workers = Object.keys(byAgency[ag]).sort();
      const headDays = weekIsoDates.map(iso=>`<th class="mono">${escapeHtml(niceDayLabel(iso))}</th>`).join('');
      const body = workers.map(w=>{
        const rec = byAgency[ag][w];
        const tds = weekIsoDates.map(iso=>{
          const d = rec.d[iso];
          if(!d) return `<td class="mono">—</td>`;
          return `<td class="mono">${formatHeuresFR(d.h)}${d.c ? ` — ${escapeHtml(d.c)}`:''}</td>`;
        }).join('');
        return `<tr>
          <td class="sticky-col">${escapeHtml(w)}</td>
          ${tds}
          <td class="mono">${formatHeuresFR(rec.total)}</td>
        </tr>`;
      }).join('');
      return `
        <div class="table-wrap" style="margin-bottom:18px">
          <div class="pill" style="margin:8px">${escapeHtml(ag)}</div>
          <table>
            <thead><tr><th class="sticky-col">Ouvrier</th>${headDays}<th>Total</th></tr></thead>
            <tbody>${body}</tbody>
          </table>
        </div>
      `;
    }).join('');
  }

  // Ouvre Outlook via mailto avec corps = HTML encodé (certains clients l’affichent en texte)
  function openOutlookHtml(to, subject, html){
    const url = `mailto:${encodeURIComponent(to)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(html)}`;
    window.location.href = url;
  }

  async function sendEmails(){
    const selected = [...document.querySelectorAll('.agChk:checked')].map(c=>c.value);
    if(selected.length===0){ alert("Sélectionne au moins une agence."); return; }
    const mapEmail = Object.fromEntries(storage.get(KEYS.agences, DEFAULT_AGENCES).map(a=>[a.nom, a.email||""]));
    for(const ag of selected){
      const to = (mapEmail[ag]||"").trim();
      if(!to){ console.warn("Aucun email pour", ag); continue; }
      const subject = `Synthèse hebdo — ${ag} — Semaine ${dWeek.value}/${dYear.value}`;
      const html = buildHtmlEmail(ag);
      openOutlookHtml(to, subject, html);
    }
    setDirty(route,false);
  }

  dYear.addEventListener('change', ()=>{ renderTables(); setDirty(route,true); });
  dWeek.addEventListener('change', ()=>{ renderTables(); setDirty(route,true); });
  document.addEventListener('change', (e)=>{ if(e.target.classList?.contains('agChk')) setDirty(route,true); });

  async function save(){ setDirty(route,false); }
  saveHandlers[route]=save;

  document.getElementById('save').addEventListener('click', save);
  document.getElementById('send').addEventListener('click', sendEmails);

  renderTables(); setDirty(route,false);
}

/* =================
   PARAMÈTRES
   ================= */
function renderParametres(){
  const route='/parametres';
  const params = storage.get(KEYS.params, DEFAULT_PARAMS);

  pageRoot.innerHTML = `
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Paramètres</span></div>
        <div class="toolbar"><button class="btn" id="save">Enregistrer</button></div>
      </div>
      <div class="panel-b">
        <div class="form-vert" style="max-width:520px">
          <div class="row"><label>Qualifications (une par ligne)</label>
            <textarea id="qualifs" placeholder="N1&#10;N2&#10;N3P1&#10;N3P2&#10;N4P1&#10;N4P2">${escapeHtml(params.qualifs.join('\n'))}</textarea>
          </div>
        </div>
      </div>
    </section>
  `;

  document.getElementById('qualifs').addEventListener('input', ()=>setDirty(route,true));
  async function save(){
    const newParams = {
      qualifs: document.getElementById('qualifs').value.split('\n').map(s=>s.trim()).filter(Boolean),
    };
    storage.set(KEYS.params, newParams);
    setDirty(route,false);
  }
  saveHandlers[route]=save; document.getElementById('save').addEventListener('click', save);
  setDirty(route,false);
}
</script>
</body>
</html>