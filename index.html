<!DOCTYPE html><html lang="fr"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Pointages Intérim – Suite complète</title>
<style>
:root{--bg:#f8fafc;--panel:#fff;--muted:#64748b;--border:#e2e8f0;--text:#0f172a;--accent:#0ea5e9;--danger:#ef4444}
*{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:linear-gradient(#f8fafc,#fff);color:var(--text)}
.container{max-width:1400px;margin:24px auto;padding:0 16px}.row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}.sp{height:8px}.muted{color:var(--muted)}.right{display:flex;justify-content:flex-end}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}.panel .hd{padding:12px 16px;border-bottom:1px solid var(--border)}.panel .bd{padding:14px 16px}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input[type=text],input[type=date],select,textarea{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:14px;outline:none}textarea{min-height:44px}
button{appearance:none;border:1px solid var(--border);background:#fff;padding:9px 12px;border-radius:10px;font-weight:600;cursor:pointer}button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
.badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:12px}.badges{display:flex;flex-wrap:wrap;gap:8px}
.grid{display:grid;gap:12px}.scroll{overflow:auto}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:980px}
th,td{border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:8px 10px;background:#fff;vertical-align:top}
th:first-child,td:first-child{border-left:1px solid var(--border)}tr:first-child th{border-top:1px solid var(--border)}th{position:sticky;top:0;background:#f8fafc;font-size:13px;text-align:left;z-index:1}
tfoot td{background:#f1f5f9;font-weight:700}.small{font-size:12px;color:var(--muted)}.hidden{display:none}
.nav{position:sticky;top:0;background:#ffffffcc;backdrop-filter:saturate(180%) blur(4px);border-bottom:1px solid var(--border);z-index:10}
.nav .wrap{max-width:1400px;margin:0 auto;padding:8px 12px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.nav a{padding:8px 12px;border:1px solid var(--border);border-radius:10px;text-decoration:none;color:inherit}.nav a.active{background:#e0f2fe;border-color:#bae6fd}
.brand{display:flex;align-items:center;gap:10px}
.brand img{height:28px;object-fit:contain}
.col-week{background:#eef6ff;font-weight:700;text-align:center}.col-day{font-size:11px;color:#334155}
.kbd{border:1px solid var(--border);border-radius:6px;padding:2px 6px;font-size:12px;background:#fff}
</style></head><body>
<div class="nav"><div class="wrap">
  <div class="brand">
    <img id="logo-bourdarios" alt="Bourdarios" src="" referrerpolicy="no-referrer"/>
    <strong>Pointages Intérim</strong>
  </div>
  <a href="#home" data-page="home" class="active">Accueil</a>
  <a href="#chantiers" data-page="chantiers">Chantiers</a>
  <a href="#ouvriers" data-page="ouvriers">Ouvriers</a>
  <a href="#agences" data-page="agences">Agences</a>
  <a href="#pointage" data-page="pointage">Pointage hebdo</a>
  <a href="#planning" data-page="planning">Planning annuel</a>
  <a href="#diffusion" data-page="diffusion">Diffusion</a>
</div></div>

<div class="container">
<!-- Accueil (épuré : juste un petit panneau d’infos rapides si besoin) -->
<section id="page-home">
  <div class="panel"><div class="hd"><strong>Pointages Intérim</strong></div>
    <div class="bd small">
      <span class="kbd">Ouvriers</span> → gérer identité, agence, métier, qualification · 
      <span class="kbd">Pointage</span> → saisir heures & chantier par jour · 
      <span class="kbd">Diffusion</span> → tableaux par agence + e-mail.
    </div>
  </div>
</section>

<!-- Chantiers -->
<section id="page-chantiers" class="hidden">
  <div class="panel"><div class="hd"><strong>Chantiers</strong></div>
    <div class="bd">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div><label>Nom du chantier</label><input type="text" id="ch-nom" placeholder="Ex : M96 W01S"></div>
        <div><label>Code DA</label><input type="text" id="ch-code" placeholder="Code DA"></div>
        <div><label>Nom DA</label><input type="text" id="ch-nomda" placeholder="Nom DA"></div>
        <div><label>Encadrant</label><input type="text" id="ch-enc" placeholder="Encadrant"></div>
        <div style="grid-column:1/-1"><label>Adresse</label><input type="text" id="ch-addr" placeholder="Adresse complète"></div>
        <div style="align-self:end"><button id="btn-add-chantier" class="primary">Ajouter le chantier</button></div>
      </div>
      <div class="sp"></div>
      <div class="scroll"><table id="tbl-chantiers"></table></div>
    </div>
  </div>
</section>

<!-- Ouvriers -->
<section id="page-ouvriers" class="hidden">
  <div class="panel"><div class="hd"><strong>Ouvriers</strong></div>
    <div class="bd">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(190px,1fr))">
        <div><label>Prénom</label><input type="text" id="ov-prenom"></div>
        <div><label>Nom</label><input type="text" id="ov-nom"></div>
        <div><label>Agence</label><select id="ov-agence"></select></div>
        <div><label>Métier</label><input type="text" id="ov-metier" placeholder="Plâquiste, carreleur…"></div>
        <div><label>Qualification</label><select id="ov-qual"><option></option><option>N1P1</option><option>N2P1</option><option>N2P2</option><option>N3P1</option><option>N3P2</option></select></div>
        <div style="align-self:end"><button id="btn-add-ouvrier" class="primary">Ajouter l'ouvrier</button></div>
      </div>
      <div class="sp"></div>
      <div class="scroll"><table id="tbl-ouvriers"></table></div>
    </div>
  </div>
</section>

<!-- Agences -->
<section id="page-agences" class="hidden">
  <div class="panel"><div class="hd"><strong>Agences</strong></div>
    <div class="bd">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr))">
        <div><label>Agence</label><input type="text" id="ag-nom" placeholder="YES / SAMSIC / …"></div>
        <div><label>Contact e-mail</label><input type="text" id="ag-mail" placeholder="contact@agence.fr"></div>
        <div style="align-self:end"><button id="btn-add-agence" class="primary">Ajouter l'agence</button></div>
      </div>
      <div class="sp"></div>
      <div class="scroll"><table id="tbl-agences"></table></div>
    </div>
  </div>
</section>

<!-- Pointage hebdo -->
<section id="page-pointage" class="hidden">
  <div class="row" style="justify-content:space-between;align-items:flex-end">
    <div><h1 style="margin:0 0 4px;font-size:28px">Pointage hebdo</h1><div class="small" id="subtitle"></div></div>
    <div class="row"><label class="badge"><input type="checkbox" id="chk-lock"> Verrouiller</label></div>
  </div>
  <div class="panel" style="margin-top:16px">
    <div class="hd"><strong>Paramètres & filtres</strong></div>
    <div class="bd grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))">
      <div><label>Semaine à pointer</label><div class="row"><input type="date" id="inp-week-pointer"><button id="btn-week-today">Aujourd'hui</button></div></div>
      <div><label>Recherche</label><input type="text" id="inp-search" placeholder="Nom, agence, chantier…"></div>
    </div>
    <div class="bd row"><div><div class="small">Filtre Agence</div><div id="badges-agencies" class="badges"></div></div><div><div class="small">Filtre Chantier</div><div id="badges-chantiers" class="badges"></div></div></div>
  </div>
  <div class="panel" style="margin-top:16px">
    <div class="hd"><strong>Saisie hebdomadaire</strong><div class="small">Toutes les lignes viennent des Ouvriers. Bouton « Heures classiques » : 7,5h lun-jeu, 7h ven, 0 sam-dim.</div></div>
    <div class="bd scroll"><table id="tbl-rows"></table></div>
  </div>
</section>

<!-- Planning annuel -->
<section id="page-planning" class="hidden">
  <div class="panel"><div class="hd"><strong>Planning annuel</strong></div>
    <div class="bd">
      <div class="row"><div><label>Année</label><input type="text" id="pl-year" placeholder="2025" style="width:120px"></div><div style="align-self:end"><button id="btn-pl-generate" class="primary">Générer</button></div></div>
      <div class="sp"></div><div class="scroll"><table id="tbl-planning"></table></div>
      <div class="small">2 lignes / ouvrier : <em>Heures</em> (format « 00,00 Heures ») puis <em>Chantier</em>. Entêtes « Semaine XX ».</div>
    </div>
  </div>
</section>

<!-- Diffusion -->
<section id="page-diffusion" class="hidden">
  <div class="panel"><div class="hd"><strong>Diffusion aux agences</strong></div>
    <div class="bd">
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(240px,1fr))">
        <div><label>Semaine à diffuser</label><input type="date" id="df-week"></div>
        <div><label>Agences</label><div id="df-agencies" class="badges"></div></div>
      </div>
      <div class="sp"></div><div class="right"><button id="btn-df-generate" class="primary">Générer les tableaux</button></div>
      <div class="sp"></div>
      <div id="df-results"></div>
      <div class="sp"></div>
      <div id="df-mails" class="small"></div>
    </div>
  </div>
</section>
</div>

<script>
(()=>{"use strict";
/* ------- Logos ------- */
const LOGO_BOURDARIOS_URL = ""; // ← colle ici l’URL de ton logo (SVG/PNG). Ex: "https://exemple.com/bourdarios.png"
if(LOGO_BOURDARIOS_URL){ const img=document.getElementById("logo-bourdarios"); if(img) img.src=LOGO_BOURDARIOS_URL; }

/* ------- Constantes & utils ------- */
const DAY_KEYS=["mon","tue","wed","thu","fri","sat","sun"],DAY_LABELS={mon:"Lun",tue:"Mar",wed:"Mer",thu:"Jeu",fri:"Ven",sat:"Sam",sun:"Dim"};
const LS_ROWS="ptg_rows_v5",LS_META="ptg_meta_v5",LS_ENTS="ptg_entities_v5",MAX_DAILY=10,$=s=>document.querySelector(s);
const fmt=d=>new Date(d).toLocaleDateString("fr-FR"),
isoWeekStart=d=>{let x=new Date(d),g=(x.getDay()+6)%7;x.setDate(x.getDate()-g);x.setHours(0,0,0,0);return x},
addDays=(d,n)=>{let x=new Date(d);x.setDate(x.getDate()+n);return x},
toDateInput=d=>{let x=new Date(d.getTime()-d.getTimezoneOffset()*6e4);return x.toISOString().slice(0,10)},
uid=()=>Math.random().toString(36).slice(2,9),
hourOptions=Array.from({length:21},(_,i)=>(i*.5).toFixed(1).replace(/\.0$/,""));

/* ------- Normalisations ------- */
const trimLower=s=>(s||"").trim().toLowerCase();
function toTitleCaseHyphen(name){ // "jean-marc" -> "Jean-Marc"
  return (name||"").split("-").map(part=>part?part[0].toUpperCase()+part.slice(1).toLowerCase():"").join("-");
}
function toUpper(s){return (s||"").toUpperCase();}
function chantierNameUpper(s){return toUpper((s||"").trim());}

/* ------- État ------- */
let weekStart=isoWeekStart(new Date),search="",agencyFilter=[],chantierFilter=[],lock=false;
let data={agencies:[],chantiers:[],ouvriers:[],rows:[]}; // rows: {id,week,workerId,days:{mon:{h,chantier},...}}

/* ------- Persistance ------- */
function save(){localStorage.setItem(LS_ENTS,JSON.stringify({agencies:data.agencies,chantiers:data.chantiers,ouvriers:data.ouvriers}));localStorage.setItem(LS_ROWS,JSON.stringify(data.rows));localStorage.setItem(LS_META,JSON.stringify({weekStart,lock}))}
function load(){try{let e=JSON.parse(localStorage.getItem(LS_ENTS)||"null");if(e){data.agencies=e.agencies||[];data.chantiers=e.chantiers||[];data.ouvriers=e.ouvriers||[]}}catch{}
try{let r=JSON.parse(localStorage.getItem(LS_ROWS)||"null");if(Array.isArray(r))data.rows=r}catch{};try{let m=JSON.parse(localStorage.getItem(LS_META)||"null");if(m){if(m.weekStart)weekStart=new Date(m.weekStart);if(m.lock)lock=!!m.lock}}catch{}
if(!data.agencies.length)data.agencies=[{name:"SAMSIC",email:""},{name:"BPS",email:""},{name:"SOVITRAT",email:""},{name:"YES",email:""}];
if(!data.chantiers.length)data.chantiers=[{id:uid(),name:"M91",code:"",nomda:"",enc:"",addr:""},{id:uid(),name:"M96",code:"",nomda:"",enc:"",addr:""}]}
load();

/* ------- Clés & calculs ------- */
function toWeekKey(d){const s=isoWeekStart(d);let t=new Date(Date.UTC(s.getFullYear(),s.getMonth(),s.getDate())),dn=t.getUTCDay()||7;t.setUTCDate(t.getUTCDate()+4-dn);const yStart=new Date(Date.UTC(t.getUTCFullYear(),0,1));const w=Math.ceil((((t-yStart)/864e5)+1)/7);return `${t.getUTCFullYear()}-W${String(w).padStart(2,"0")}`}

/* ------- Routing ------- */
function showPage(n){["home","chantiers","ouvriers","agences","pointage","planning","diffusion"].forEach(p=>{const el=$("#page-"+p);if(!el)return;el.classList.toggle("hidden",p!==n)});document.querySelectorAll(".nav a").forEach(a=>a.classList.toggle("active",a.dataset.page===n));
if(n==="chantiers")renderChantiers();if(n==="ouvriers")renderOuvriers();if(n==="agences")renderAgences();if(n==="pointage")renderPointage();if(n==="planning"){}if(n==="diffusion")renderDiffusionBadges()}
document.querySelectorAll(".nav a").forEach(a=>a.addEventListener("click",e=>{e.preventDefault();showPage(a.dataset.page)}));

/* ------- Helpers UI ------- */
function setSubtitle(){$("#subtitle").textContent=`Semaine du ${fmt(isoWeekStart(weekStart))}`}function fillWeekInput(){const el=$("#inp-week-pointer");if(el)el.value=toDateInput(weekStart)}
function hoursSelect(v){const s=document.createElement("select");s.innerHTML=hourOptions.map(x=>`<option value="${x}" ${String(v)===String(x)?"selected":""}>${x}</option>`).join("");return s}
function chantierSelect(val){const s=document.createElement("select");s.innerHTML='<option value=""></option>'+data.chantiers.map(c=>`<option ${val===c.name?"selected":""}>${c.name}</option>`).join("");return s}

/* ===================== AGENCES ===================== */
function renderAgences(){const tbl=$("#tbl-agences");tbl.innerHTML="";const th=document.createElement("thead"),trh=document.createElement("tr");["Agence","E-mail"," "].forEach(h=>{const th1=document.createElement("th");th1.textContent=h;trh.appendChild(th1)});th.appendChild(trh);tbl.appendChild(th);
const tb=document.createElement("tbody");data.agencies.forEach(a=>{const tr=document.createElement("tr");let td=document.createElement("td");const inpn=document.createElement("input");inpn.type="text";inpn.value=a.name;inpn.oninput=()=>{a.name=inpn.value;save()};td.appendChild(inpn);tr.appendChild(td);
td=document.createElement("td");const inpe=document.createElement("input");inpe.type="text";inpe.value=a.email||"";inpe.oninput=()=>{a.email=inpe.value;save()};td.appendChild(inpe);tr.appendChild(td);
td=document.createElement("td");const del=document.createElement("button");del.textContent="×";del.onclick=()=>{if(confirm("Supprimer ?")){data.agencies=data.agencies.filter(x=>x!==a);save();renderAgences()}};td.appendChild(del);tr.appendChild(td);tb.appendChild(tr)});tbl.appendChild(tb)}
$("#btn-add-agence")?.addEventListener("click",()=>{const n=$("#ag-nom").value.trim(),m=$("#ag-mail").value.trim();
const dup=data.agencies.some(a=>trimLower(a.name)===trimLower(n)&&trimLower(a.email||"")===trimLower(m||""));
if(dup){alert("Cette agence existe déjà.");return}
if(n){data.agencies.unshift({name:n,email:m});save();renderAgences()}})

/* ===================== CHANTIERS ===================== */
function renderChantiers(){const tbl=$("#tbl-chantiers");tbl.innerHTML="";const th=document.createElement("thead"),trh=document.createElement("tr");["Nom chantier","Code DA","Nom DA","Encadrant","Adresse"," "].forEach(h=>{const th1=document.createElement("th");th1.textContent=h;trh.appendChild(th1)});th.appendChild(trh);tbl.appendChild(th);
const tb=document.createElement("tbody");data.chantiers.forEach(c=>{const tr=document.createElement("tr");
let td=document.createElement("td");const in1=document.createElement("input");in1.value=c.name||"";in1.oninput=()=>{c.name=in1.value;save()};td.appendChild(in1);tr.appendChild(td);
td=document.createElement("td");const in2=document.createElement("input");in2.value=c.code||"";in2.oninput=()=>{c.code=in2.value;save()};td.appendChild(in2);tr.appendChild(td);
td=document.createElement("td");const in3=document.createElement("input");in3.value=c.nomda||"";in3.oninput=()=>{c.nomda=in3.value;save()};td.appendChild(in3);tr.appendChild(td);
td=document.createElement("td");const in4=document.createElement("input");in4.value=c.enc||"";in4.oninput=()=>{c.enc=in4.value;save()};td.appendChild(in4);tr.appendChild(td);
td=document.createElement("td");const in5=document.createElement("input");in5.value=c.addr||"";in5.oninput=()=>{c.addr=in5.value;save()};td.appendChild(in5);tr.appendChild(td);
td=document.createElement("td");const del=document.createElement("button");del.textContent="×";del.onclick=()=>{if(confirm("Supprimer ?")){data.chantiers=data.chantiers.filter(x=>x!==c);save();renderChantiers()}};td.appendChild(del);tr.appendChild(td);
tb.appendChild(tr)});tbl.appendChild(tb)}
$("#btn-add-chantier")?.addEventListener("click",()=>{const nom=chantierNameUpper($("#ch-nom").value),code=$("#ch-code").value.trim(),nomda=$("#ch-nomda").value.trim(),enc=$("#ch-enc").value.trim(),addr=$("#ch-addr").value.trim();
const dup=data.chantiers.some(c=>chantierNameUpper(c.name)===nom&&trimLower(c.code)===trimLower(code)&&trimLower(c.nomda)===trimLower(nomda)&&trimLower(c.enc)===trimLower(enc)&&trimLower(c.addr)===trimLower(addr));
if(dup){alert("Ce chantier existe déjà.");return}
if(nom){data.chantiers.unshift({id:uid(),name:nom,code,nomda,enc,addr});save();renderChantiers()}})

/* ===================== OUVRIERS ===================== */
function renderOuvriers(){const sel=$("#ov-agence");sel.innerHTML='<option value=""></option>'+data.agencies.map(a=>`<option>${a.name}</option>`).join("");
const tbl=$("#tbl-ouvriers");tbl.innerHTML="";const th=document.createElement("thead"),trh=document.createElement("tr");["Prénom","Nom","Agence","Métier","Qualification"," "].forEach(h=>{const th1=document.createElement("th");th1.textContent=h;trh.appendChild(th1)});th.appendChild(trh);tbl.appendChild(th);
const tb=document.createElement("tbody");data.ouvriers.forEach(o=>{const tr=document.createElement("tr");
let td=document.createElement("td");const inpf=document.createElement("input");inpf.value=o.first||"";inpf.oninput=()=>{o.first=inpf.value;save()};inpf.onblur=()=>{inpf.value=toTitleCaseHyphen(inpf.value)};td.appendChild(inpf);tr.appendChild(td);
td=document.createElement("td");const inpl=document.createElement("input");inpl.value=o.last||"";inpl.oninput=()=>{o.last=inpl.value;save()};inpl.onblur=()=>{inpl.value=toUpper(inpl.value)};td.appendChild(inpl);tr.appendChild(td);
td=document.createElement("td");const s=document.createElement("select");s.innerHTML='<option value=""></option>'+data.agencies.map(a=>`<option ${o.agency===a.name?"selected":""}>${a.name}</option>`).join("");s.onchange=()=>{o.agency=s.value;save()};td.appendChild(s);tr.appendChild(td);
td=document.createElement("td");const met=document.createElement("input");met.value=o.metier||"";met.oninput=()=>{o.metier=met.value;save()};td.appendChild(met);tr.appendChild(td);
td=document.createElement("td");const q=document.createElement("select");q.innerHTML='<option></option><option>N1P1</option><option>N2P1</option><option>N2P2</option><option>N3P1</option><option>N3P2</option>';q.value=o.qual||"";q.onchange=()=>{o.qual=q.value;save()};td.appendChild(q);tr.appendChild(td);
td=document.createElement("td");const del=document.createElement("button");del.textContent="×";del.onclick=()=>{if(confirm("Supprimer ?")){data.ouvriers=data.ouvriers.filter(x=>x.id!==o.id);data.rows=data.rows.filter(r=>r.workerId!==o.id);save();renderOuvriers()}};td.appendChild(del);tr.appendChild(td);
tb.appendChild(tr)});tbl.appendChild(tb)}
$("#btn-add-ouvrier")?.addEventListener("click",()=>{const f=toTitleCaseHyphen($("#ov-prenom").value.trim()),l=toUpper($("#ov-nom").value.trim()),ag=$("#ov-agence").value,met=$("#ov-metier").value.trim(),qual=$("#ov-qual").value;
const dup=data.ouvriers.some(o=>trimLower(o.first)===trimLower(f)&&trimLower(o.last)===trimLower(l)&&trimLower(o.agency)===trimLower(ag)&&trimLower(o.metier)===trimLower(met)&&trimLower(o.qual)===trimLower(qual));
if(dup){alert("Cet ouvrier existe déjà.");return}
if(f||l){data.ouvriers.unshift({id:uid(),first:f,last:l,agency:ag||"",metier:met||"",qual:qual||""});save();renderOuvriers()}})

/* ===================== POINTAGE HEBDO ===================== */
function rowsForWeek(ws){const key=toWeekKey(ws);return data.rows.filter(r=>r.week===key)}
function ensureWeekRows(ws){const wk=toWeekKey(ws);const have=new Set(rowsForWeek(ws).map(r=>r.workerId));data.ouvriers.forEach(o=>{if(!have.has(o.id)){data.rows.push({id:uid(),week:wk,workerId:o.id,days:{mon:{h:0,chantier:""},tue:{h:0,chantier:""},wed:{h:0,chantier:""},thu:{h:0,chantier:""},fri:{h:0,chantier:""},sat:{h:0,chantier:""},sun:{h:0,chantier:""}}})}});save()}
function workerById(id){return data.ouvriers.find(o=>o.id===id)||{first:"",last:"",agency:"",metier:"",qual:""}}
function filtered(list){return list.filter(r=>{const w=workerById(r.workerId),okA=agencyFilter.length?agencyFilter.includes(w.agency):true,chs=Object.values(r.days||{}).map(d=>d.chantier).filter(Boolean),okC=chantierFilter.length?chs.some(c=>chantierFilter.includes(c)):true,okS=!search||(`${w.first} ${w.last} ${w.agency} ${w.metier} ${w.qual} ${chs.join(" ")}`.toLowerCase().includes(search.toLowerCase()));return okA&&okC&&okS})}
function totalsPerDay(list){const t={mon:0,tue:0,wed:0,thu:0,fri:0,sat:0,sun:0};filtered(list).forEach(r=>{DAY_KEYS.forEach(k=>{const v=r.days?.[k]?.h;if(typeof v==="number")t[k]+=v})});return t}
function renderBadges(){const bag=$("#badges-agencies");if(!bag)return;bag.innerHTML="";const allA=Array.from(new Set(data.agencies.map(a=>a.name).concat(data.ouvriers.map(o=>o.agency).filter(Boolean)))).sort();
allA.forEach(a=>{const b=document.createElement("button");b.className="badge";b.textContent=a;if(agencyFilter.includes(a))b.style.background="#e0f2fe";b.onclick=()=>{agencyFilter=agencyFilter.includes(a)?agencyFilter.filter(x=>x!==a):[...agencyFilter,a];renderPointage()};bag.appendChild(b)});
const rz=document.createElement("button");rz.className="badge";rz.textContent="Réinitialiser";rz.onclick=()=>{agencyFilter=[];renderPointage()};bag.appendChild(rz);
const bch=$("#badges-chantiers");bch.innerHTML="";const allC=Array.from(new Set(data.chantiers.map(c=>c.name).concat(data.rows.flatMap(r=>Object.values(r.days||{}).map(d=>d.chantier||""))))).filter(Boolean).sort();
allC.forEach(c=>{const b=document.createElement("button");b.className="badge";b.textContent=c;if(chantierFilter.includes(c))b.style.background="#e0f2fe";b.onclick=()=>{chantierFilter=chantierFilter.includes(c)?chantierFilter.filter(x=>x!==c):[...chantierFilter,c];renderPointage()};bch.appendChild(b)});
const rz2=document.createElement("button");rz2.className="badge";rz2.textContent="Réinitialiser";rz2.onclick=()=>{chantierFilter=[];renderPointage()};bch.appendChild(rz2)}
function setSubtitle(){$("#subtitle").textContent=`Semaine du ${fmt(isoWeekStart(weekStart))}`}function fillWeekInput(){const el=$("#inp-week-pointer");if(el)el.value=toDateInput(weekStart)}
function applyClassicHours(r){r.days.mon.h=7.5;r.days.tue.h=7.5;r.days.wed.h=7.5;r.days.thu.h=7.5;r.days.fri.h=7;r.days.sat.h=0;r.days.sun.h=0}
function renderPointage(){ensureWeekRows(weekStart);setSubtitle();fillWeekInput();renderBadges();
const tbl=$("#tbl-rows");tbl.innerHTML="";const thead=document.createElement("thead"),trh=document.createElement("tr");
["Agence","Prénom","Nom","Métier","Qualification","Lun","Mar","Mer","Jeu","Ven","Sam","Dim","Total","Heures classiques"].forEach((h,i)=>{const th=document.createElement("th");th.textContent=h;if(i>=5&&i<=11){const d=addDays(isoWeekStart(weekStart),i-5);th.innerHTML=`<div>${h}</div><div class='small'>${fmt(d)}</div>`}trh.appendChild(th)});thead.appendChild(trh);tbl.appendChild(thead);
const list=filtered(rowsForWeek(weekStart));const tbody=document.createElement("tbody");
list.forEach(r=>{const w=workerById(r.workerId);const tr=document.createElement("tr");
let td=document.createElement("td");td.textContent=w.agency||"";tr.appendChild(td);
td=document.createElement("td");td.textContent=toTitleCaseHyphen(w.first)||"";tr.appendChild(td);
td=document.createElement("td");td.textContent=toUpper(w.last)||"";tr.appendChild(td);
td=document.createElement("td");td.textContent=w.metier||"";tr.appendChild(td);
td=document.createElement("td");td.textContent=w.qual||"";tr.appendChild(td);
DAY_KEYS.forEach(k=>{const cell=document.createElement("td"),wrap=document.createElement("div");
const selH=hoursSelect(r.days?.[k]?.h===""?"":(typeof r.days?.[k]?.h==="number"?r.days[k].h:""));selH.disabled=lock;selH.onchange=()=>{r.days=r.days||{};r.days[k]=r.days[k]||{h:"",chantier:""};r.days[k].h=Number(selH.value);save();renderPointage()};
const selC=chantierSelect(r.days?.[k]?.chantier||"");selC.disabled=lock;selC.onchange=()=>{r.days=r.days||{};r.days[k]=r.days[k]||{h:"",chantier:""};r.days[k].chantier=selC.value;save()};
wrap.appendChild(selH);const s=document.createElement("div");s.className="sp";wrap.appendChild(s);wrap.appendChild(selC);cell.appendChild(wrap);tr.appendChild(cell)});
td=document.createElement("td");td.style.textAlign="right";td.style.fontWeight="700";td.textContent=String(DAY_KEYS.reduce((a,k)=>a+(r.days?.[k]?.h||0),0));tr.appendChild(td);
td=document.createElement("td");const b=document.createElement("button");b.textContent="Heures classiques";b.onclick=()=>{applyClassicHours(r);save();renderPointage()};td.appendChild(b);tr.appendChild(td);
tbody.appendChild(tr)});tbl.appendChild(tbody);
const tfoot=document.createElement("tfoot"),trf=document.createElement("tr"),tdb=document.createElement("td");tdb.colSpan=5;trf.appendChild(tdb);
DAY_KEYS.forEach(k=>{const td=document.createElement("td");td.style.textAlign="center";td.style.fontWeight="700";td.textContent=String(totalsPerDay(rowsForWeek(weekStart))[k]);trf.appendChild(td)});const tdt=document.createElement("td");tdt.style.fontWeight="800";tdt.style.textAlign="right";tdt.textContent=String(Object.values(totalsPerDay(rowsForWeek(weekStart))).reduce((a,b)=>a+b,0));trf.appendChild(tdt);
const tdf=document.createElement("td");trf.appendChild(tdf);tfoot.appendChild(trf);tbl.appendChild(tfoot)
}
$("#btn-week-today")?.addEventListener("click",()=>{weekStart=isoWeekStart(new Date);save();renderPointage()});
$("#inp-week-pointer")?.addEventListener("change",e=>{weekStart=isoWeekStart(new Date(e.target.value));save();renderPointage()});
$("#chk-lock")?.addEventListener("change",()=>{lock=$("#chk-lock").checked;save();renderPointage()});
$("#inp-search")?.addEventListener("input",e=>{search=e.target.value;renderPointage()});

/* ===================== PLANNING ANNUEL ===================== */
function renderPlanning(){const tbl=$("#tbl-planning");tbl.innerHTML="";const year=parseInt($("#pl-year").value||String(new Date().getFullYear()),10);if(!year){tbl.innerHTML='<tr><td class="small">Saisir une année valide.</td></tr>';return}
const start=new Date(year,0,1),end=new Date(year,11,31);const days=[];for(let d=new Date(start);d<=end;d.setDate(d.getDate()+1)){days.push(new Date(d))}
const weeks=[];let curW="";days.forEach(d=>{const wk=toWeekKey(d);if(wk!==curW){weeks.push({key:wk,days:[d]});curW=wk}else weeks[weeks.length-1].days.push(d)});
const thead=document.createElement("thead"),trWeek=document.createElement("tr"),trDay=document.createElement("tr");
const thName=document.createElement("th");thName.rowSpan=2;thName.textContent="Ouvrier";trWeek.appendChild(thName);
weeks.forEach(w=>{const th=document.createElement("th");th.colSpan=w.days.length;th.className="col-week";th.textContent=`Semaine ${w.key.split("-W")[1]}`;trWeek.appendChild(th);w.days.forEach(d=>{const thd=document.createElement("th");thd.className="col-day";thd.textContent=d.toLocaleDateString("fr-FR",{weekday:"short",day:"2-digit",month:"2-digit"});trDay.appendChild(thd)})});
thead.appendChild(trWeek);thead.appendChild(trDay);tbl.appendChild(thead);
const tb=document.createElement("tbody");if(!data.ouvriers.length){const tr=document.createElement("tr"),td=document.createElement("td");td.colSpan=weeks.reduce((a,w)=>a+w.days.length,1);td.className="small";td.textContent="Ajoutez des ouvriers pour générer le planning.";tr.appendChild(td);tb.appendChild(tr);tbl.appendChild(tb);return}
data.ouvriers.forEach(o=>{const trH=document.createElement("tr"),tdH=document.createElement("td");tdH.textContent=`${toTitleCaseHyphen(o.first||"")} ${toUpper(o.last||"")} – Heures`;trH.appendChild(tdH);
weeks.forEach(w=>{w.days.forEach(d=>{const cell=document.createElement("td");const wk=toWeekKey(d);const rr=data.rows.find(r=>r.week===wk&&r.workerId===o.id);if(rr){const map=["sun","mon","tue","wed","thu","fri","sat"];const dk=map[d.getDay()];const de=rr.days?.[dk];if(de&&de.h>=0){let txt=(de.h||0).toFixed(2).replace(".",",");cell.textContent=`${txt} Heures`}}trH.appendChild(cell)})});tb.appendChild(trH);
const trC=document.createElement("tr"),tdC=document.createElement("td");tdC.textContent=`${toTitleCaseHyphen(o.first||"")} ${toUpper(o.last||"")} – Chantier`;trC.appendChild(tdC);
weeks.forEach(w=>{w.days.forEach(d=>{const cell=document.createElement("td");const wk=toWeekKey(d);const rr=data.rows.find(r=>r.week===wk&&r.workerId===o.id);if(rr){const map=["sun","mon","tue","wed","thu","fri","sat"];const dk=map[d.getDay()];const de=rr.days?.[dk];if(de&&(de.chantier||"")){cell.textContent=de.chantier}}trC.appendChild(cell)})});tb.appendChild(trC)});tbl.appendChild(tb)}
$("#btn-pl-generate")?.addEventListener("click",()=>renderPlanning());

/* ===================== DIFFUSION ===================== */
let dfSelected=new Set();
function renderDiffusionBadges(){const box=$("#df-agencies");box.innerHTML="";data.agencies.forEach(a=>{const b=document.createElement("button");b.className="badge";b.textContent=a.name;if(dfSelected.has(a.name))b.style.background="#e0f2fe";b.onclick=()=>{dfSelected.has(a.name)?dfSelected.delete(a.name):dfSelected.add(a.name);renderDiffusionBadges()};box.appendChild(b)});
const rz=document.createElement("button");rz.className="badge";rz.textContent="Tout";rz.onclick=()=>{if(dfSelected.size===data.agencies.length)dfSelected.clear();else dfSelected=new Set(data.agencies.map(a=>a.name));renderDiffusionBadges()};box.appendChild(rz)}
function renderDiffusionTables(){const zone=$("#df-results");const mailZone=$("#df-mails");zone.innerHTML="";mailZone.innerHTML="";
const d=$("#df-week").value;const wk=toWeekKey(new Date(d||new Date));
const rows=data.rows.filter(r=>r.week===wk);const byAgency={};
rows.forEach(r=>{const w=data.ouvriers.find(o=>o.id===r.workerId);if(!w||!w.agency)return;if(dfSelected.size && !dfSelected.has(w.agency))return;(byAgency[w.agency]=byAgency[w.agency]||[]).push({w,r})});
const daysLbl=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];
Object.keys(byAgency).sort().forEach(ag=>{
  const wrap=document.createElement("div");wrap.className="panel";wrap.style.marginBottom="16px";
  const hd=document.createElement("div");hd.className="hd";hd.innerHTML=`<strong>${ag}</strong> — semaine ${wk}`;wrap.appendChild(hd);
  const bd=document.createElement("div");bd.className="bd";const tbl=document.createElement("table");
  const thead=document.createElement("thead"),trh=document.createElement("tr");
  ["Ouvrier / Type"].concat(daysLbl).forEach(h=>{const th=document.createElement("th");th.textContent=h;trh.appendChild(th)});thead.appendChild(trh);tbl.appendChild(thead);
  const tb=document.createElement("tbody");
  byAgency[ag].forEach(({w,r})=>{
    const trH=document.createElement("tr");let td=document.createElement("td");td.textContent=`${toTitleCaseHyphen(w.first)} ${toUpper(w.last)} – Heures`;trH.appendChild(td);
    DAY_KEYS.forEach(k=>{const tdj=document.createElement("td");const h=r.days?.[k]?.h||0;tdj.textContent=(h||0).toFixed(2).replace(".",",");trH.appendChild(tdj)});tb.appendChild(trH);
    const trC=document.createElement("tr");td=document.createElement("td");td.textContent=`${toTitleCaseHyphen(w.first)} ${toUpper(w.last)} – Chantier`;trC.appendChild(td);
    DAY_KEYS.forEach(k=>{const tdj=document.createElement("td");tdj.textContent=r.days?.[k]?.chantier||"";trC.appendChild(tdj)});tb.appendChild(trC);
  });
  tbl.appendChild(tb);bd.appendChild(tbl);wrap.appendChild(bd);zone.appendChild(wrap);

  /* Préparation e-mail (mailto) */
  const agencyObj=data.agencies.find(a=>a.name===ag);
  const mails=document.createElement("div");
  const subject=encodeURIComponent(`Pointages - ${ag} - ${wk}`);
  // construit un tableau texte simple
  let body=""; body+=`Agence: ${ag} – Semaine ${wk}%0D%0A`;
  body+=["Ouvrier/Type"].concat(daysLbl).join("\t")+"%0D%0A";
  byAgency[ag].forEach(({w,r})=>{
    body+=`${toTitleCaseHyphen(w.first)} ${toUpper(w.last)} – Heures\t${DAY_KEYS.map(k=>(r.days?.[k]?.h||0).toFixed(2).replace(".",",")).join("\t")}%0D%0A`;
    body+=`${toTitleCaseHyphen(w.first)} ${toUpper(w.last)} – Chantier\t${DAY_KEYS.map(k=>(r.days?.[k]?.chantier||"")).join("\t")}%0D%0A`;
  });
  const href=`mailto:${encodeURIComponent(agencyObj?.email||"")}?subject=${subject}&body=${body}`;
  mails.innerHTML=`<a class="badge" href="${href}">📧 Préparer l'e-mail à ${ag}</a>`;
  mailZone.appendChild(mails);
});
if(!Object.keys(byAgency).length){zone.innerHTML='<div class="small">Aucune donnée pour cette sélection.</div>'}}
$("#btn-df-generate")?.addEventListener("click",renderDiffusionTables);

/* ------- Filtres & inputs pointage ------- */
function renderFilters(){/* already inline in renderPointage via renderBadges */}

/* ------- Init ------- */
function init(){const w=$("#df-week");if(w)w.value=toDateInput(weekStart);setSubtitle();fillWeekInput();showPage("home")}
init();
})();
</script>
</body></html>