<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Suite chantier — Planning • Pointage • Diffusion • Ouvriers • Agences • Chantiers • Paramètres</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --ink:#e8ebf1; --muted:#9aa4b2;
    --accent:#4da3ff; --ok:#35c759; --warn:#ff9f0a; --err:#ff453a; --line:#262b36;
    --chip:#202532; --radius:12px;
    --font: ui-sans-serif, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  }
  html,body{height:100%}
  body{margin:0; background:linear-gradient(180deg,#0d1016,#121723 40%,#0d1016); color:var(--ink); font-family:var(--font); -webkit-font-smoothing:antialiased;}
  a{color:inherit; text-decoration:none}
  .wrap{max-width:1260px; margin:24px auto 56px; padding:0 20px;}
  .header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px;}
  .title{font-size: clamp(20px, 2.6vw, 28px); font-weight:700}
  .badge{display:inline-flex; align-items:center; gap:10px; padding:10px 14px; background:var(--chip); border:1px solid var(--line); border-radius:999px; font-size:14px; color:var(--muted);}
  .dot{width:10px; height:10px; border-radius:50%; box-shadow:0 0 0 2px rgba(0,0,0,.25) inset;}
  .dot.orange{background:var(--warn)} .dot.green{background:var(--ok)}
  .nav{display:flex; gap:8px; background:var(--panel); border:1px solid var(--line); border-radius:999px; padding:6px; flex-wrap:wrap}
  .tab{padding:8px 14px; border-radius:999px; color:#c9d1e1; border:1px solid transparent}
  .tab.active{background:#263049; border-color:#35405e}
  .panel{background:var(--panel); border:1px solid var(--line); border-radius:var(--radius); overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,.25); margin-top:14px}
  .panel-h{display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--line);}
  .panel-b{padding:16px;}
  .toolbar{display:flex; flex-wrap:wrap; gap:10px}
  .btn{padding:10px 14px; border-radius:10px; border:1px solid var(--line); background:#1d2330; color:#e8ebf1; font-size:14px; cursor:pointer; transition:.15s transform ease, .2s background ease; user-select:none;}
  .btn:hover{transform: translateY(-1px)} .btn.primary{background:linear-gradient(180deg,#2d6bff,#2254d7); border-color:#1e3ea8}
  .btn.ghost{background:transparent}
  .btn.destructive{background:linear-gradient(180deg,#ff5a5f,#d7263d); border-color:#9d1628}
  .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}
  .pill{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; background:#1a2130; border:1px solid var(--line); color:#cbd5e4;}
  .hint{color:var(--muted); font-size:13px; margin-top:10px}
  .field{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  input[type="text"], input[type="email"], input[type="number"], input[type="date"], select, textarea{
    background:#0e1422; color:var(--ink); border:1px solid var(--line); border-radius:10px; padding:10px 12px; font-size:14px;
  }
  textarea{width:100%; min-height:120px}
  .grow{flex:1} .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  .grid{display:grid; gap:12px}
  .grid.cols-2{grid-template-columns: repeat(2, minmax(0, 1fr))}
  .grid.cols-3{grid-template-columns: repeat(3, minmax(0, 1fr))}
  @media (max-width: 980px){ .grid.cols-2,.grid.cols-3{grid-template-columns: 1fr} }
  .table-wrap{width:100%; overflow:auto; border-radius:10px; border:1px solid var(--line);}
  table{width:100%; border-collapse:collapse; min-width:900px; background:#0f131c}
  thead th{position:sticky; top:0; backdrop-filter: blur(6px); background:#0f131cee; color:#c9d1e1; font-weight:600; text-align:left; font-size:13px; letter-spacing:.2px; border-bottom:1px solid var(--line); padding:10px 12px;}
  tbody td{border-bottom:1px solid var(--line); padding:9px 12px; font-size:14px; color:#e5e9f3}
  tbody tr:hover{background:#121829}
  tfoot td{background:#0f131c; font-weight:600}
  .kpi{display:flex; gap:10px; flex-wrap:wrap}
  .kpi .card{background:#101526; border:1px solid var(--line); border-radius:12px; padding:12px 14px; min-width:160px}
  .kpi .card .v{font-size:20px; font-weight:700}
  .modal-backdrop{position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:50}
  .modal{background:var(--panel); border:1px solid var(--line); border-radius:12px; width:min(560px, 92vw); box-shadow:0 12px 40px rgba(0,0,0,.45)}
  .modal .m-h{padding:14px 16px; border-bottom:1px solid var(--line); font-weight:600}
  .modal .m-b{padding:16px}
  .modal .m-f{display:flex; gap:10px; justify-content:flex-end; padding:12px 16px; border-top:1px solid var(--line)}
  .show{display:flex}
  /* cellules pointage double-ligne (heures + chantier) */
  .pcell{display:flex; flex-direction:column; gap:6px; min-width:140px}
  .pcell select{width:100%}
  /* planning daily: fine header */
  .dayhead{writing-mode:vertical-rl; transform:rotate(180deg); font-size:11px; white-space:nowrap}
</style>

<!-- EmailJS -->
<script defer src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // ⚠️ Remplacer par ta clé publique EmailJS
    // eslint-disable-next-line no-undef
    emailjs.init({ publicKey: "REMPLACE_AVEC_TA_PUBLIC_KEY" });
  });
</script>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">Suite chantier — Suivi global</div>
      <nav class="nav" id="nav">
        <a href="#/planning"   class="tab" data-route="/planning">Planning</a>
        <a href="#/pointage"   class="tab" data-route="/pointage">Pointage</a>
        <a href="#/diffusion"  class="tab" data-route="/diffusion">Diffusion</a>
        <a href="#/ouvriers"   class="tab" data-route="/ouvriers">Ouvriers</a>
        <a href="#/agences"    class="tab" data-route="/agences">Agences</a>
        <a href="#/chantiers"  class="tab" data-route="/chantiers">Chantiers</a>
        <a href="#/parametres" class="tab" data-route="/parametres">Paramètres</a>
      </nav>
      <div class="badge" id="saveBadge">
        <span class="dot orange" id="saveDot"></span>
        <span id="saveText">Modifications non enregistrées</span>
      </div>
    </div>
    <main id="page"></main>
  </div>

  <!-- Modal de confirmation -->
  <div class="modal-backdrop" id="confirmModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <div class="m-h" id="confirmTitle">Enregistrer les modifications ?</div>
      <div class="m-b"><p class="hint">Des modifications non enregistrées sont présentes sur cette page.</p></div>
      <div class="m-f">
        <button class="btn" id="btnKeep">Continuer sans enregistrer</button>
        <button class="btn primary" id="btnSaveAndGo">Enregistrer et continuer</button>
        <button class="btn ghost" id="btnCancelNav">Annuler</button>
      </div>
    </div>
  </div>

<script type="module">
/* =========================
   ROUTER & STATE
   ========================= */
const pageRoot = document.getElementById('page');
const routes = {
  '/planning': renderPlanningDaily,          // ← planning sur tous les jours de l'année
  '/pointage': renderPointageWeekly,         // ← hebdo: heures + chantier / jour
  '/diffusion': renderDiffusionParAgence,    // ← détail jour par jour + sélection agences
  '/ouvriers': renderOuvriers,
  '/agences': renderAgences,
  '/chantiers': renderChantiers,
  '/parametres': renderParametres,
};
const dirtyState = Object.fromEntries(Object.keys(routes).map(r=>[r,false]));
let currentRoute = '/planning', pendingRoute = null;
const modal = document.getElementById('confirmModal');
const btnKeep = document.getElementById('btnKeep');
const btnSaveAndGo = document.getElementById('btnSaveAndGo');
const btnCancelNav = document.getElementById('btnCancelNav');
const saveHandlers = {}; // callbacks d'enregistrement par page

function setDirty(route, isDirty){ dirtyState[route] = !!isDirty; updateBadge(); }
function updateBadge(){
  const dot = document.getElementById('saveDot');
  const text = document.getElementById('saveText');
  if(dirtyState[currentRoute]){ dot.classList.remove('green'); dot.classList.add('orange'); text.textContent = "Modifications non enregistrées"; }
  else { dot.classList.remove('orange'); dot.classList.add('green'); text.textContent = "Enregistré"; }
}
function activateTab(route){ document.querySelectorAll('.tab').forEach(a=>a.classList.toggle('active', a.dataset.route === route)); }
function showConfirm(){ modal.classList.add('show'); }
function hideConfirm(){ modal.classList.remove('show'); }
btnCancelNav.addEventListener('click', ()=>{ pendingRoute=null; hideConfirm(); });
btnKeep.addEventListener('click', ()=>{ hideConfirm(); navigate(pendingRoute, {force:true}); pendingRoute=null; });
btnSaveAndGo.addEventListener('click', async ()=>{ hideConfirm(); await saveHandlers[currentRoute]?.(); navigate(pendingRoute, {force:true}); pendingRoute=null; });
window.addEventListener('beforeunload', (e)=>{ if(dirtyState[currentRoute]){ e.preventDefault(); e.returnValue=''; } });

function navigate(route, opts={}){
  if(!routes[route]) route='/planning';
  if(!opts.force && dirtyState[currentRoute]){ pendingRoute = route; showConfirm(); return; }
  currentRoute = route; window.location.hash = '#'+route; activateTab(route);
  routes[route](); updateBadge();
}
function handleHash(){
  const hash = window.location.hash.replace(/^#/, '') || '/planning';
  if(hash !== currentRoute){ navigate(hash); } else { navigate(currentRoute, {force:true}); }
}
window.addEventListener('hashchange', handleHash);
document.addEventListener('DOMContentLoaded', handleHash);

/* =========
   STORAGE
   ========= */
const storage = {
  get(k, fb){ try{ const v = JSON.parse(localStorage.getItem(k)); return v ?? fb; }catch{ return fb; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); }
};
const KEYS = {
  ouvriers:  'app_ouvriers_v3',
  agences:   'app_agences_v3',
  chantiers: 'app_chantiers_v3',
  pointage:  'app_pointage_v3',   // {date, ouvrier, agence, chantier, heures}
  planning:  'app_planning_daily_v1', // { [year]: { [fullName]: { [YYYY-MM-DD]: "txt" } } }
  params:    'app_params_v3',
};

/* =========
   DONNÉES PAR DÉFAUT
   ========= */
const DEFAULT_OUVRIERS = [
  { prenom:"Baudouin", nom:"RIBERON", metier:"Plâquiste", qualification:"N3P1", agence:"SAMSIC" },
  { prenom:"Laurent",  nom:"JOLY",    metier:"Plombier",  qualification:"N3P2", agence:"BPS" },
  { prenom:"Jean-Marc",nom:"GOUZY",   metier:"Polyvalent",qualification:"N4P1", agence:"SAMSIC" },
];
const DEFAULT_AGENCES = [
  { nom:"SAMSIC", email:"samsic@exemple.com" },
  { nom:"BPS",    email:"bps@exemple.com" },
  { nom:"SOVITRAT", email:"sovitrat@exemple.com" },
];
const DEFAULT_CHANTIERS = [
  { code:"M96 W19S", numDA:"", nomDA:"", encadrant:"Alexis", adresse:"", zone:"" },
  { code:"M91 N10S", numDA:"", nomDA:"", encadrant:"Jérémy", adresse:"", zone:"" },
  { code:"M65 W01S", numDA:"", nomDA:"", encadrant:"Paul",   adresse:"", zone:"" },
];
const DEFAULT_PARAMS = {
  qualifs:["N1","N2","N3P1","N3P2","N4P1","N4P2"],
  signature:"Cordialement,\nL'équipe Bourdarios",
};

/* =========
   UTILITAIRES
   ========= */
function escapeHtml(s=""){ return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;"); }
function formatHeuresFR(v){ const n = Number(v??0); return `${n.toFixed(2).replace(".",",")} Heures`; }
function fullName(o){ return `${o.prenom} ${o.nom}`.trim(); }
function getISOWeek(d){
  const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = date.getUTCDay() || 7;
  date.setUTCDate(date.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(date.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((date - yearStart) / 86400000) + 1)/7);
  return {year: date.getUTCFullYear(), week: weekNo};
}
function weeksOfYear(year){ const dec28 = new Date(Date.UTC(year,11,28)); return getISOWeek(dec28).week; }
function daysOfYear(year){
  const start = new Date(Date.UTC(year,0,1));
  const end = new Date(Date.UTC(year+1,0,1));
  const out=[]; for(let d=new Date(start); d<end; d.setUTCDate(d.getUTCDate()+1)){
    out.push(new Date(d));
  } return out;
}
function dateISO(d){ const x=new Date(d); x.setHours(0,0,0,0); return x.toISOString().slice(0,10); }
function weekDatesISO(year, week){
  const simple = new Date(Date.UTC(year,0,4));
  const dayOfWeek = simple.getUTCDay() || 7;
  const monday = new Date(simple); monday.setUTCDate(simple.getUTCDate() - dayOfWeek + 1 + (week-1)*7);
  return [...Array(7)].map((_,i)=>new Date(monday.getTime()+i*86400000).toISOString().slice(0,10));
}

/* =================
   PAGE: OUVRIERS
   ================= */
function renderOuvriers(){
  const route='/ouvriers';
  const params = storage.get(KEYS.params, DEFAULT_PARAMS);
  const agences = storage.get(KEYS.agences, DEFAULT_AGENCES).map(a=>a.nom);
  const rows = storage.get(KEYS.ouvriers, DEFAULT_OUVRIERS);

  pageRoot.innerHTML = `
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Ouvriers — Ajouter & Récap</span></div>
        <div class="toolbar"><button class="btn" id="save">Enregistrer</button></div>
      </div>
      <div class="panel-b">
        <div class="grid cols-3" style="margin-bottom:12px">
          <div class="field"><label class="pill">Prénom</label><input id="iPrenom" type="text" /></div>
          <div class="field"><label class="pill">Nom</label><input id="iNom" type="text" /></div>
          <div class="field"><label class="pill">Métier</label><input id="iMetier" type="text" /></div>
          <div class="field"><label class="pill">Qualification</label>
            <select id="iQualif">${params.qualifs.map(q=>`<option>${q}</option>`).join('')}</select>
          </div>
          <div class="field"><label class="pill">Agence</label>
            <select id="iAgence">${agences.map(a=>`<option>${a}</option>`).join('')}</select>
          </div>
          <div class="field"><label class="pill">&nbsp;</label>
            <button class="btn primary" id="add">Ajouter l'ouvrier</button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead><tr><th>Prénom</th><th>Nom</th><th>Métier</th><th>Qualification</th><th>Agence</th><th></th></tr></thead>
            <tbody id="tb"></tbody>
          </table>
        </div>
        <p class="hint">L'ajout n'efface pas les champs (pratique pour dupliquer et changer juste le nom/prénom).</p>
      </div>
    </section>
  `;
  const tb=document.getElementById('tb');
  function rowTpl(r,i){
    return `<tr data-i="${i}">
      <td contenteditable data-k="prenom">${escapeHtml(r.prenom)}</td>
      <td contenteditable data-k="nom">${escapeHtml(r.nom)}</td>
      <td contenteditable data-k="metier">${escapeHtml(r.metier||"")}</td>
      <td contenteditable data-k="qualification">${escapeHtml(r.qualification||"")}</td>
      <td contenteditable data-k="agence">${escapeHtml(r.agence||"")}</td>
      <td><button class="btn ghost del">Suppr.</button></td>
    </tr>`;
  }
  function render(){ tb.innerHTML = rows.map(rowTpl).join(''); bind(); }
  function bind(){
    tb.querySelectorAll('[contenteditable]').forEach(el=>el.addEventListener('input', ()=> setDirty(route,true)));
    tb.querySelectorAll('.del').forEach(b=>b.addEventListener('click', e=>{
      const tr=e.target.closest('tr'); const i=+tr.dataset.i; rows.splice(i,1); render(); setDirty(route,true);
    }));
  }
  document.getElementById('add').addEventListener('click', ()=>{
    const prenom = document.getElementById('iPrenom').value.trim();
    const nom    = document.getElementById('iNom').value.trim();
    if(!prenom || !nom) { alert("Prénom et Nom requis"); return; }
    rows.push({ prenom, nom,
      metier: document.getElementById('iMetier').value.trim(),
      qualification: document.getElementById('iQualif').value,
      agence: document.getElementById('iAgence').value });
    render(); setDirty(route,true);
  });
  async function save(){
    const out=[]; tb.querySelectorAll('tr').forEach(tr=>{
      out.push({
        prenom:(tr.querySelector('[data-k="prenom"]')?.textContent||"").trim(),
        nom:(tr.querySelector('[data-k="nom"]')?.textContent||"").trim(),
        metier:(tr.querySelector('[data-k="metier"]')?.textContent||"").trim(),
        qualification:(tr.querySelector('[data-k="qualification"]')?.textContent||"").trim(),
        agence:(tr.querySelector('[data-k="agence"]')?.textContent||"").trim(),
      });
    });
    storage.set(KEYS.ouvriers,out); setDirty(route,false);
  }
  saveHandlers[route]=save; document.getElementById('save').addEventListener('click', save);
  render(); setDirty(route,false);
}

/* =================
   PAGE: AGENCES
   ================= */
function renderAgences(){
  const route='/agences';
  const rows = storage.get(KEYS.agences, DEFAULT_AGENCES);
  pageRoot.innerHTML=`
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Agences — Ajouter & Récap</span></div>
        <div class="toolbar"><button class="btn" id="save">Enregistrer</button></div>
      </div>
      <div class="panel-b">
        <div class="grid cols-3" style="margin-bottom:12px">
          <div class="field"><label class="pill">Nom</label><input id="aNom" type="text" /></div>
          <div class="field"><label class="pill">Email(s)</label><input id="aEmail" type="email" placeholder="plusieurs séparés par des virgules"/></div>
          <div class="field"><label class="pill">&nbsp;</label><button class="btn primary" id="add">Ajouter l'agence</button></div>
        </div>

        <div class="table-wrap">
          <table>
            <thead><tr><th>Nom</th><th>Email(s)</th><th></th></tr></thead>
            <tbody id="tb"></tbody>
          </table>
        </div>
      </div>
    </section>
  `;
  const tb=document.getElementById('tb');
  function rowTpl(r,i){ return `<tr data-i="${i}">
    <td contenteditable data-k="nom">${escapeHtml(r.nom)}</td>
    <td contenteditable data-k="email">${escapeHtml(r.email||"")}</td>
    <td><button class="btn ghost del">Suppr.</button></td>
  </tr>`;}
  function render(){ tb.innerHTML=rows.map(rowTpl).join(''); bind(); }
  function bind(){
    tb.querySelectorAll('[contenteditable]').forEach(el=>el.addEventListener('input',()=>setDirty(route,true)));
    tb.querySelectorAll('.del').forEach(b=>b.addEventListener('click',e=>{
      const tr=e.target.closest('tr'); const i=+tr.dataset.i; rows.splice(i,1); render(); setDirty(route,true);
    }));
  }
  document.getElementById('add').addEventListener('click',()=>{
    const nom=document.getElementById('aNom').value.trim();
    if(!nom){ alert("Nom requis"); return; }
    rows.push({nom, email: document.getElementById('aEmail').value.trim()});
    render(); setDirty(route,true);
  });
  async function save(){
    const out=[]; tb.querySelectorAll('tr').forEach(tr=>{
      out.push({ nom:(tr.querySelector('[data-k="nom"]')?.textContent||"").trim(),
                 email:(tr.querySelector('[data-k="email"]')?.textContent||"").trim() });
    });
    storage.set(KEYS.agences,out); setDirty(route,false);
  }
  saveHandlers[route]=save; document.getElementById('save').addEventListener('click', save);
  render(); setDirty(route,false);
}

/* =================
   PAGE: CHANTIERS
   ================= */
function renderChantiers(){
  const route='/chantiers';
  const rows = storage.get(KEYS.chantiers, DEFAULT_CHANTIERS);
  pageRoot.innerHTML=`
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Chantiers — Ajouter & Récap</span></div>
        <div class="toolbar"><button class="btn" id="save">Enregistrer</button></div>
      </div>
      <div class="panel-b">
        <div class="grid cols-3" style="margin-bottom:12px">
          <div class="field"><label class="pill">Code</label><input id="cCode" type="text" /></div>
          <div class="field"><label class="pill">Numéro DA</label><input id="cDA" type="text" /></div>
          <div class="field"><label class="pill">Nom DA</label><input id="cNomDA" type="text" /></div>
          <div class="field"><label class="pill">Encadrant</label><input id="cEnc" type="text" /></div>
          <div class="field"><label class="pill">Adresse</label><input id="cAdr" type="text" /></div>
          <div class="field"><label class="pill">Zone</label><input id="cZone" type="text" /></div>
          <div class="field"><label class="pill">&nbsp;</label><button class="btn primary" id="add">Ajouter le chantier</button></div>
        </div>

        <div class="table-wrap">
          <table>
            <thead><tr><th>Code</th><th>Numéro DA</th><th>Nom DA</th><th>Encadrant</th><th>Adresse</th><th>Zone</th><th></th></tr></thead>
            <tbody id="tb"></tbody>
          </table>
        </div>
      </div>
    </section>
  `;
  const tb=document.getElementById('tb');
  function rowTpl(r,i){ return `<tr data-i="${i}">
    <td contenteditable data-k="code">${escapeHtml(r.code)}</td>
    <td contenteditable data-k="numDA">${escapeHtml(r.numDA||"")}</td>
    <td contenteditable data-k="nomDA">${escapeHtml(r.nomDA||"")}</td>
    <td contenteditable data-k="encadrant">${escapeHtml(r.encadrant||"")}</td>
    <td contenteditable data-k="adresse">${escapeHtml(r.adresse||"")}</td>
    <td contenteditable data-k="zone">${escapeHtml(r.zone||"")}</td>
    <td><button class="btn ghost del">Suppr.</button></td>
  </tr>`;}
  function render(){ tb.innerHTML=rows.map(rowTpl).join(''); bind(); }
  function bind(){
    tb.querySelectorAll('[contenteditable]').forEach(el=>el.addEventListener('input',()=>setDirty(route,true)));
    tb.querySelectorAll('.del').forEach(b=>b.addEventListener('click',e=>{
      const tr=e.target.closest('tr'); const i=+tr.dataset.i; rows.splice(i,1); render(); setDirty(route,true);
    }));
  }
  document.getElementById('add').addEventListener('click',()=>{
    const code=document.getElementById('cCode').value.trim();
    if(!code){ alert("Code requis"); return; }
    rows.push({
      code,
      numDA: document.getElementById('cDA').value.trim(),
      nomDA: document.getElementById('cNomDA').value.trim(),
      encadrant: document.getElementById('cEnc').value.trim(),
      adresse: document.getElementById('cAdr').value.trim(),
      zone: document.getElementById('cZone').value.trim(),
    });
    render(); setDirty(route,true);
  });
  async function save(){
    const out=[]; tb.querySelectorAll('tr').forEach(tr=>{
      out.push({
        code:(tr.querySelector('[data-k="code"]')?.textContent||"").trim(),
        numDA:(tr.querySelector('[data-k="numDA"]')?.textContent||"").trim(),
        nomDA:(tr.querySelector('[data-k="nomDA"]')?.textContent||"").trim(),
        encadrant:(tr.querySelector('[data-k="encadrant"]')?.textContent||"").trim(),
        adresse:(tr.querySelector('[data-k="adresse"]')?.textContent||"").trim(),
        zone:(tr.querySelector('[data-k="zone"]')?.textContent||"").trim(),
      });
    });
    storage.set(KEYS.chantiers,out); setDirty(route,false);
  }
  saveHandlers[route]=save; document.getElementById('save').addEventListener('click', save);
  render(); setDirty(route,false);
}

/* =================
   PAGE: PLANNING — TOUS LES JOURS DE L'ANNÉE
   ================= */
function renderPlanningDaily(){
  const route='/planning';
  const ouvriers = storage.get(KEYS.ouvriers, DEFAULT_OUVRIERS);
  const planning = storage.get(KEYS.planning, {}); // { [year]: { [fullName]: { [dateISO]: "txt" } } }
  const currentYear = new Date().getFullYear();
  const years = Array.from({length:5},(_,i)=>currentYear-2+i);
  const ySel = planning.__year || currentYear;
  const days = daysOfYear(ySel); // Date[]

  pageRoot.innerHTML = `
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Planning — ${ySel} (tous les jours)</span></div>
        <div class="toolbar">
          <select id="yearSel">${years.map(y=>`<option ${y===ySel?'selected':''}>${y}</option>`).join('')}</select>
          <button class="btn" id="save">Enregistrer</button>
        </div>
      </div>
      <div class="panel-b">
        <div class="table-wrap">
          <table style="min-width:1400px">
            <thead>
              <tr>
                <th>Ouvrier</th>
                ${days.map(d=>{
                  const m = d.toLocaleDateString('fr-FR',{month:'short'});
                  const day = d.getUTCDate();
                  return `<th><div class="dayhead">${m} ${String(day).padStart(2,'0')}</div></th>`;
                }).join('')}
              </tr>
            </thead>
            <tbody id="tb"></tbody>
          </table>
        </div>
        <p class="hint">Chaque cellule est éditable (texte libre : chantier prévu, note, etc.).</p>
      </div>
    </section>
  `;

  const tb = document.getElementById('tb');
  function rowTpl(w){
    const name = fullName(w);
    const pYear = (planning[ySel] && planning[ySel][name]) ? planning[ySel][name] : {};
    return `<tr data-worker="${escapeHtml(name)}">
      <td class="mono">${escapeHtml(name)}</td>
      ${days.map(d=>{
        const iso = dateISO(d);
        const v = pYear?.[iso] || "";
        return `<td contenteditable class="pg" data-date="${iso}">${escapeHtml(v)}</td>`;
      }).join('')}
    </tr>`;
  }
  function render(){ tb.innerHTML = ouvriers.map(rowTpl).join(''); bind(); }
  function bind(){ tb.querySelectorAll('.pg').forEach(td=>td.addEventListener('input', ()=> setDirty(route,true))); }

  document.getElementById('yearSel').addEventListener('change', ()=>{
    planning.__year = parseInt(document.getElementById('yearSel').value,10);
    storage.set(KEYS.planning, planning);
    renderPlanningDaily();
  });

  async function save(){
    const y = parseInt(document.getElementById('yearSel').value,10);
    planning.__year = y; planning[y] = planning[y] || {};
    document.querySelectorAll('tbody tr').forEach(tr=>{
      const worker = tr.dataset.worker;
      planning[y][worker] = planning[y][worker] || {};
      tr.querySelectorAll('[data-date]').forEach(td=>{
        const iso = td.dataset.date;
        planning[y][worker][iso] = td.textContent.trim();
      });
    });
    storage.set(KEYS.planning, planning); setDirty(route,false);
  }
  saveHandlers[route]=save; document.getElementById('save').addEventListener('click', save);
  render(); setDirty(route,false);
}

/* =================
   PAGE: POINTAGE — HEBDO (heures + chantier / jour)
   ================= */
function renderPointageWeekly(){
  const route='/pointage';
  const ouvriers = storage.get(KEYS.ouvriers, DEFAULT_OUVRIERS).map(o=>({ ...o, nomComplet: fullName(o) }));
  const chantiers= storage.get(KEYS.chantiers, DEFAULT_CHANTIERS).map(c=>c.code);
  const pointage = storage.get(KEYS.pointage, []); // rows: {date, ouvrier, agence, chantier, heures}

  const {year:curY, week:curW} = getISOWeek(new Date());

  pageRoot.innerHTML = `
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Pointage — Semaine</span></div>
        <div class="toolbar">
          <div class="field">
            <label class="pill">Année</label><input type="number" id="pYear" value="${curY}" style="width:110px"/>
            <label class="pill">Semaine (ISO)</label><input type="number" id="pWeek" value="${curW}" min="1" max="53" style="width:110px"/>
          </div>
          <button class="btn" id="save">Enregistrer</button>
        </div>
      </div>
      <div class="panel-b">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Ouvrier</th>
                <th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th>
                <th>Total</th>
                <th>Auto (heures)</th>
              </tr>
            </thead>
            <tbody id="tb"></tbody>
            <tfoot>
              <tr>
                <td style="font-weight:600">Total jour (heures)</td>
                <td class="mono" id="totLun">0.00</td>
                <td class="mono" id="totMar">0.00</td>
                <td class="mono" id="totMer">0.00</td>
                <td class="mono" id="totJeu">0.00</td>
                <td class="mono" id="totVen">0.00</td>
                <td class="mono" id="totSem" colspan="2">0.00</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <p class="hint">Chaque cellule comporte <b>Heures</b> (liste 0→10, pas 0,5) et <b>Chantier</b> (liste des chantiers existants). Le bouton <b>Auto</b> ne remplit que les heures (7,5 lun→jeu ; 7 ven).</p>
      </div>
    </section>
  `;

  const pYear = document.getElementById('pYear');
  const pWeek = document.getElementById('pWeek');
  const tb    = document.getElementById('tb');

  function hoursOptions(selVal){
    const opts = [];
    for(let v=0; v<=10; v+=0.5){
      const sel = (+v === +selVal) ? 'selected' : '';
      opts.push(`<option value="${v.toFixed(1)}" ${sel}>${v.toFixed(1)}</option>`);
    }
    return opts.join('');
  }
  function chantierOptions(selVal){
    return `<option value=""></option>` + chantiers.map(c=>`<option ${c===selVal?'selected':''}>${c}</option>`).join('');
  }

  function daysForWeek(year, week){ return weekDatesISO(year, week).slice(0,5); } // lun→ven

  function getMapForWeek(year, week){
    const dates = daysForWeek(year, week);
    const map = new Map(); // name -> {jours:[{h,c},...]}
    ouvriers.forEach(o=> map.set(o.nomComplet, { worker:o, jours:dates.map(()=>({h:0,c:""})) }));
    pointage.filter(r=> dates.includes(r.date)).forEach(r=>{
      const idx = dates.indexOf(r.date); const ref = map.get(r.ouvrier);
      if(ref){ ref.jours[idx] = { h:(+r.heures||0), c:(r.chantier||"") }; }
    });
    return {map, dates};
  }

  function renderTable(){
    const year = parseInt(pYear.value,10);
    const week = parseInt(pWeek.value,10);
    const { map, dates } = getMapForWeek(year, week);

    tb.innerHTML = [...map.values()].map(({worker, jours})=>{
      const total = jours.reduce((s,j)=>s+(+j.h||0),0);
      return `<tr data-worker="${escapeHtml(worker.nomComplet)}">
        <td class="mono">${escapeHtml(worker.nomComplet)}</td>
        ${jours.map((j,idx)=>`
          <td>
            <div class="pcell">
              <select class="hsel" data-day="${idx}">${hoursOptions(j.h)}</select>
              <select class="csel" data-day="${idx}">${chantierOptions(j.c)}</select>
            </div>
          </td>
        `).join('')}
        <td class="mono rowTotal">${total.toFixed(2)}</td>
        <td><button class="btn ghost autoOne">Auto</button></td>
      </tr>`;
    }).join('');

    bindRowEvents(dates);
    recomputeTotals();
  }

  function bindRowEvents(dates){
    // heures
    tb.querySelectorAll('select.hsel').forEach(sel=>{
      sel.addEventListener('change', ()=>{
        setDirty('/pointage', true);
        const tr = sel.closest('tr');
        const vals = [...tr.querySelectorAll('select.hsel')].map(s=>+s.value||0);
        tr.querySelector('.rowTotal').textContent = vals.reduce((s,h)=>s+h,0).toFixed(2);
        recomputeTotals();
      });
    });
    // chantier
    tb.querySelectorAll('select.csel').forEach(sel=>{
      sel.addEventListener('change', ()=> setDirty('/pointage', true));
    });
    // auto par ouvrier (heures seulement)
    tb.querySelectorAll('.autoOne').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const tr = btn.closest('tr');
        const selects = [...tr.querySelectorAll('select.hsel')];
        selects.forEach((s,idx)=>{ s.value = (idx<4 ? 7.5 : 7.0).toFixed(1); });
        setDirty('/pointage', true);
        selects.forEach(s=>s.dispatchEvent(new Event('change')));
      });
    });
  }

  function recomputeTotals(){
    const idxs = [0,1,2,3,4];
    const colTotals = idxs.map(i=>{
      let sum=0;
      tb.querySelectorAll(`select.hsel[data-day="${i}"]`).forEach(s=> sum += (+s.value||0));
      return sum;
    });
    document.getElementById('totLun').textContent = colTotals[0].toFixed(2);
    document.getElementById('totMar').textContent = colTotals[1].toFixed(2);
    document.getElementById('totMer').textContent = colTotals[2].toFixed(2);
    document.getElementById('totJeu').textContent = colTotals[3].toFixed(2);
    document.getElementById('totVen').textContent = colTotals[4].toFixed(2);
    const totSem = colTotals.reduce((s,x)=>s+x,0);
    document.getElementById('totSem').textContent = totSem.toFixed(2);
  }

  pYear.addEventListener('input', ()=>{ renderTable(); setDirty(route,true); });
  pWeek.addEventListener('input', ()=>{ renderTable(); setDirty(route,true); });

  async function save(){
    const year = parseInt(pYear.value,10);
    const week = parseInt(pWeek.value,10);
    const dates = daysForWeek(year, week); // lun..ven

    // Filtrer l'ancienne semaine
    const keep = storage.get(KEYS.pointage, []).filter(r=> !dates.includes(r.date));

    // Pour chaque ouvrier/jour, on enregistre une ligne si heures > 0 ou chantier non vide
    tb.querySelectorAll('tr[data-worker]').forEach(tr=>{
      const ouvrier = tr.dataset.worker;
      const agence = (storage.get(KEYS.ouvriers, DEFAULT_OUVRIERS).find(o=>fullName(o)===ouvrier)?.agence)||"";
      tr.querySelectorAll('.pcell').forEach((cell,dayIdx)=>{
        const h = +cell.querySelector('.hsel').value || 0;
        const c = (cell.querySelector('.csel').value || "").trim();
        if(h>0 || c){
          keep.push({ date: dates[dayIdx], ouvrier, agence, chantier: c, heures: h });
        }
      });
    });

    storage.set(KEYS.pointage, keep);
    setDirty(route,false);
  }
  saveHandlers[route]=save;
  document.getElementById('save').addEventListener('click', save);

  renderTable();
  setDirty(route,false);
}

/* =================
   PAGE: DIFFUSION — par Agence avec détail jour par jour
   ================= */
function renderDiffusionParAgence(){
  const route='/diffusion';
  const pointage = storage.get(KEYS.pointage, []);
  const agencesObj = storage.get(KEYS.agences, DEFAULT_AGENCES);

  const {year:curY, week:curW} = getISOWeek(new Date());

  pageRoot.innerHTML = `
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Diffusion — par Agence (détail jour par jour)</span></div>
        <div class="toolbar">
          <div class="field">
            <label class="pill">Année</label>
            <input type="number" id="dYear" value="${curY}" style="width:110px"/>
            <label class="pill">Semaine (ISO)</label>
            <input type="number" id="dWeek" value="${curW}" min="1" max="53" style="width:110px"/>
          </div>
          <button class="btn" id="save">Enregistrer</button>
          <button class="btn primary" id="send">Envoyer les emails</button>
          <button class="btn ghost" id="preview">Aperçu emails</button>
        </div>
      </div>
      <div class="panel-b">
        <div class="field" style="margin-bottom:10px">
          <label class="pill">Agences à contacter</label>
          <div id="agList" class="field" style="gap:14px; flex-wrap:wrap"></div>
        </div>
        <div id="tables"></div>
        <p class="hint">Chaque agence voit <b>uniquement</b> ses pointages. Format heures : <span class="mono">XX,XX Heures</span>.</p>
        <div id="previewOut" class="hint"></div>
      </div>
    </section>
  `;

  const dYear = document.getElementById('dYear');
  const dWeek = document.getElementById('dWeek');
  const tablesDiv = document.getElementById('tables');
  const agListDiv = document.getElementById('agList');

  // cases à cocher des agences
  agListDiv.innerHTML = agencesObj.map(a=>{
    const safe = escapeHtml(a.nom);
    return `<label style="display:flex;align-items:center;gap:6px;border:1px solid var(--line);padding:6px 10px;border-radius:10px;background:#101526">
      <input type="checkbox" class="agChk" value="${safe}" checked />
      <span>${safe}</span>
      <span class="hint" style="margin:0">(${escapeHtml(a.email||'—')})</span>
    </label>`;
  }).join('');

  function weekDates(year, week){
    const simple = new Date(Date.UTC(year,0,4));
    const dayOfWeek = simple.getUTCDay() || 7;
    const monday = new Date(simple); monday.setUTCDate(simple.getUTCDate() - dayOfWeek + 1 + (week-1)*7);
    return [...Array(7)].map((_,i)=>new Date(monday.getTime()+i*86400000).toISOString().slice(0,10));
  }
  function niceDayLabel(iso){
    const d = new Date(iso); return d.toLocaleDateString('fr-FR',{weekday:'short', day:'2-digit', month:'2-digit'});
  }

  function groupData(){
    const year = parseInt(dYear.value,10);
    const week = parseInt(dWeek.value,10);
    const weekIsoDates = weekDates(year, week).slice(0,5); // lun→ven
    const rows = pointage.filter(r=>weekIsoDates.includes(r.date));

    // group: agence -> ouvrier -> { [iso]: {h, c}, total }
    const byAgency = {};
    rows.forEach(r=>{
      const ag = r.agence || '—';
      byAgency[ag] = byAgency[ag] || {};
      const worker = r.ouvrier;
      byAgency[ag][worker] = byAgency[ag][worker] || { d:{}, total:0 };
      byAgency[ag][worker].d[r.date] = { h:+(r.heures||0), c:r.chantier||"" };
      byAgency[ag][worker].total += (+r.heures||0);
    });
    return { byAgency, weekIsoDates };
  }

  function renderTables(){
    const { byAgency, weekIsoDates } = groupData();
    const agencies = Object.keys(byAgency).sort();
    if(agencies.length===0){ tablesDiv.innerHTML = `<p class="hint">Aucune donnée pour cette semaine.</p>`; return; }

    tablesDiv.innerHTML = agencies.map(ag=>{
      const workers = Object.keys(byAgency[ag]).sort();
      const headDays = weekIsoDates.map(iso=>`<th class="mono">${escapeHtml(niceDayLabel(iso))}</th>`).join('');
      const body = workers.map(w=>{
        const rec = byAgency[ag][w];
        const tds = weekIsoDates.map(iso=>{
          const d = rec.d[iso];
          if(!d) return `<td class="mono">—</td>`;
          return `<td class="mono">${formatHeuresFR(d.h)}${d.c ? ` — ${escapeHtml(d.c)}`:''}</td>`;
        }).join('');
        return `<tr>
          <td>${escapeHtml(w)}</td>
          ${tds}
          <td class="mono">${formatHeuresFR(rec.total)}</td>
        </tr>`;
      }).join('');
      return `
        <div style="margin-bottom:18px">
          <div class="pill" style="margin-bottom:8px">Agence: ${escapeHtml(ag)}</div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Ouvrier</th>${headDays}<th>Total</th></tr></thead>
              <tbody>${body}</tbody>
            </table>
          </div>
        </div>
      `;
    }).join('');
  }

  function buildEmailHtmlForAgency(agencyName){
    const { byAgency, weekIsoDates } = groupData();
    const recs = byAgency[agencyName] || {};
    const workers = Object.keys(recs).sort();
    const styles = `
      table{border-collapse:collapse;width:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
      th,td{border:1px solid #d5d8df;padding:8px 10px;font-size:14px}
      th{background:#f2f4f8;text-align:left}
      .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
      h3{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    `;
    const headDays = weekIsoDates.map(iso=>`<th class="mono">${escapeHtml(niceDayLabel(iso))}</th>`).join('');
    const body = workers.map(w=>{
      const rec = recs[w];
      const tds = weekIsoDates.map(iso=>{
        const d = rec.d[iso];
        if(!d) return `<td class="mono">—</td>`;
        return `<td class="mono">${formatHeuresFR(d.h)}${d.c ? ` — ${escapeHtml(d.c)}`:''}</td>`;
      }).join('');
      return `<tr><td>${escapeHtml(w)}</td>${tds}<td class="mono">${formatHeuresFR(rec.total)}</td></tr>`;
    }).join('');
    return `
      <div style="font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#0b1220">
        <style>${styles}</style>
        <p>Bonjour,</p>
        <p>Veuillez trouver ci-dessous le détail jour par jour des heures pour la semaine ${escapeHtml(String(dWeek.value))}/${escapeHtml(String(dYear.value))} — <b>${escapeHtml(agencyName)}</b> :</p>
        <table role="table"><thead><tr><th>Ouvrier</th>${headDays}<th>Total</th></tr></thead><tbody>${body}</tbody></table>
        <p style="color:#5f6b7c">— Envoi automatique</p>
      </div>
    `;
  }

  dYear.addEventListener('input', ()=>{ renderTables(); setDirty(route,true); });
  dWeek.addEventListener('input', ()=>{ renderTables(); setDirty(route,true); });
  document.querySelectorAll('.agChk').forEach(c=> c.addEventListener('change', ()=> setDirty(route,true)));

  async function save(){ setDirty(route,false); }
  saveHandlers[route]=save;

  async function preview(){
    const selected = [...document.querySelectorAll('.agChk:checked')].map(c=>c.value);
    if(selected.length===0){ alert("Sélectionne au moins une agence."); return; }
    const sections = selected.map(ag=>`<h3>${escapeHtml(ag)}</h3>${buildEmailHtmlForAgency(ag)}`).join('<hr/>');
    document.getElementById('previewOut').innerHTML = `<div class="hint">Aperçu des emails (un par agence sélectionnée) :</div><div style="margin-top:10px;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#101525">${sections}</div>`;
  }

  async function sendEmails(){
    const selected = [...document.querySelectorAll('.agChk:checked')].map(c=>c.value);
    if(selected.length===0){ alert("Sélectionne au moins une agence."); return; }
    const mapEmail = Object.fromEntries(agencesObj.map(a=>[a.nom, a.email||""]));
    const SERVICE_ID = "REMPLACE_AVEC_TON_SERVICE_ID";
    const TEMPLATE_ID = "REMPLACE_AVEC_TON_TEMPLATE_ID";

    for(const ag of selected){
      const to = (mapEmail[ag]||"").trim();
      if(!to){ console.warn("Aucun email pour", ag); continue; }
      const subject = `Synthèse hebdo — ${ag} — Semaine ${dWeek.value}/${dYear.value}`;
      const html = buildEmailHtmlForAgency(ag);
      // eslint-disable-next-line no-undef
      await emailjs.send(SERVICE_ID, TEMPLATE_ID, { to_emails: to, subject, message_html: html });
    }
    setDirty(route,false);
  }

  document.getElementById('save').addEventListener('click', save);
  document.getElementById('preview').addEventListener('click', preview);
  document.getElementById('send').addEventListener('click', sendEmails);

  renderTables(); setDirty(route,false);
}

/* =================
   PAGE: PARAMÈTRES
   ================= */
function renderParametres(){
  const route='/parametres';
  const params = storage.get(KEYS.params, DEFAULT_PARAMS);

  pageRoot.innerHTML = `
    <section class="panel">
      <div class="panel-h">
        <div class="toolbar"><span class="pill">Paramètres</span></div>
        <div class="toolbar"><button class="btn" id="save">Enregistrer</button></div>
      </div>
      <div class="panel-b">
        <div class="grid cols-2">
          <div>
            <label class="pill">Signature email</label>
            <textarea id="signature" placeholder="Signature ajoutée aux emails (optionnel)">${escapeHtml(params.signature)}</textarea>
          </div>
          <div>
            <label class="pill">Qualifications (une par ligne)</label>
            <textarea id="qualifs">${escapeHtml(params.qualifs.join('\n'))}</textarea>
          </div>
        </div>
      </div>
    </section>
  `;

  document.getElementById('signature').addEventListener('input', ()=>setDirty(route,true));
  document.getElementById('qualifs').addEventListener('input', ()=>setDirty(route,true));
  async function save(){
    const newParams = {
      signature: document.getElementById('signature').value,
      qualifs: document.getElementById('qualifs').value.split('\n').map(s=>s.trim()).filter(Boolean),
    };
    storage.set(KEYS.params, newParams);
    setDirty(route,false);
  }
  saveHandlers[route]=save; document.getElementById('save').addEventListener('click', save);
  setDirty(route,false);
}
</script>
</body>
</html>